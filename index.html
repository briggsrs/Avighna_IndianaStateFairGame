<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Indiana Treasure Quest</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      overflow-x: hidden;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b1020;
      color: #e9eefc;
      font-size: clamp(14px, 2.5vw, 16px);
    }
    .wrap {
      max-width: 900px;
      width: 100%;
      min-height: 100vh;
      min-height: 100dvh;
      margin: 0 auto;
      padding: clamp(12px, 3vw, 24px);
      display: flex;
      flex-direction: column;
    }
    .card {
      background: #121a33;
      border: 1px solid #243055;
      border-radius: clamp(10px, 2vw, 14px);
      padding: clamp(12px, 3vw, 18px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow-y: auto;
    }
    h1,h2 { margin: 0 0 clamp(8px, 2vw, 12px); }
    p { line-height: 1.5; margin-bottom: clamp(8px, 2vw, 12px); }
    .row { display: flex; gap: clamp(8px, 2vw, 12px); flex-wrap: wrap; }
    .btn {
      background: #2b63ff; border: 0; color: white; padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 14px); border-radius: clamp(8px, 1.5vw, 10px);
      cursor: pointer; font-weight: 650; transition: transform 0.1s; font-size: clamp(13px, 2.5vw, 16px);
    }
    .btn:hover { transform: scale(1.02); }
    .btn.secondary { background: #2a3356; }
    .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
    .choices { display: grid; gap: clamp(8px, 1.5vw, 10px); margin-top: clamp(8px, 2vw, 12px); }
    .choice { background:#0f1730; border:1px solid #2a3b73; padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 12px); border-radius: clamp(8px, 2vw, 12px); cursor:pointer; transition: all 0.2s; font-size: clamp(13px, 2.5vw, 16px); }
    .choice:hover { border-color:#4e7bff; transform: translateX(4px); }
    .choice.correct { border-color:#1fd18b; background: rgba(31,209,139,.15); }
    .choice.wrong { border-color:#ff5b6b; background: rgba(255,91,107,.15); }
    .topbar { display:flex; justify-content: space-between; align-items: center; gap: clamp(8px, 2vw, 12px); margin-bottom: clamp(8px, 2vw, 14px); flex-wrap: wrap; }
    .progress { height: clamp(8px, 1.5vw, 10px); background:#0f1730; border:1px solid #2a3b73; border-radius: 999px; overflow:hidden; flex: 1; min-width: 100px; }
    .progress > div { height: 100%; background: linear-gradient(90deg, #1fd18b, #2b63ff); width: 0%; transition: width 0.5s ease; }
    .pill { display:inline-block; padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 10px); border-radius: 999px; background:#1b2650; border:1px solid #2a3b73; font-size: clamp(11px, 2vw, 13px); white-space: nowrap; }
    input, textarea, select {
      width: 100%; padding: clamp(8px, 2vw, 10px) clamp(10px, 2vw, 12px); border-radius: clamp(8px, 2vw, 12px); border: 1px solid #2a3b73; background:#0f1730; color:#e9eefc;
      font-family: inherit; font-size: inherit;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23e9eefc' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
      cursor: pointer;
    }
    small { opacity: .8; }
    .avatar { width: 64px; height: 64px; border-radius: 16px; border:2px solid #2a3b73; background:#0f1730; display:flex; align-items:center; justify-content:center; font-size: 28px; cursor:pointer; transition: all 0.2s; }
    .avatar:hover { border-color:#4e7bff; transform: scale(1.05); }
    .avatar.selected { border-color:#1fd18b; box-shadow: 0 0 0 3px rgba(31,209,139,.25); }

    /* Famous Hoosier avatar cards */
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: clamp(8px, 2vw, 12px);
      margin: clamp(10px, 2vw, 16px) 0;
    }
    @media (max-width: 600px) {
      .avatar-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 400px) {
      .avatar-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
    }
    .hoosier-card {
      background: linear-gradient(135deg, #1a2744 0%, #0f1730 100%);
      border: 2px solid #2a3b73;
      border-radius: clamp(10px, 2vw, 16px);
      padding: clamp(8px, 2vw, 12px);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .hoosier-card:hover {
      border-color: #4e7bff;
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .hoosier-card.selected {
      border-color: #1fd18b;
      box-shadow: 0 0 0 3px rgba(31,209,139,.25), 0 8px 20px rgba(0,0,0,0.3);
    }
    .hoosier-card.focused {
      border-color: #4e7bff;
      outline: 2px solid #4e7bff;
      outline-offset: 2px;
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .hoosier-card:focus {
      outline: none;
    }
    .hoosier-portrait {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      position: relative;
      overflow: hidden;
    }
    .hoosier-card .name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
      color: #e9eefc;
    }
    .hoosier-card .title {
      font-size: 10px;
      opacity: 0.7;
      line-height: 1.3;
    }
    /* Individual character styles */
    .portrait-mj { background: linear-gradient(135deg, #ffd700 0%, #ff6b6b 100%); }
    .portrait-larry { background: linear-gradient(135deg, #1fd18b 0%, #ffd700 100%); }
    .portrait-james { background: linear-gradient(135deg, #ff6b6b 0%, #2b63ff 100%); }
    .portrait-abe { background: linear-gradient(135deg, #8b6914 0%, #2a3356 100%); }
    .portrait-axl { background: linear-gradient(135deg, #ff5b6b 0%, #ffd700 100%); }
    .portrait-david { background: linear-gradient(135deg, #2b63ff 0%, #64748b 100%); }
    .portrait-john { background: linear-gradient(135deg, #1fd18b 0%, #2b63ff 100%); }
    .portrait-orville { background: linear-gradient(135deg, #ffd700 0%, #fff 100%); }

    /* Pixel art sprite styles */
    .sprite-img {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .hoosier-portrait .sprite-img {
      width: 64px;
      height: 64px;
    }
    .avatar-sprite {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .scene-avatar-sprite {
      width: 72px;
      height: 72px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    /* Landmark image styles */
    .landmark-container {
      width: 100%;
      height: clamp(120px, 25vh, 200px);
      border-radius: clamp(8px, 2vw, 12px);
      overflow: hidden;
      border: 2px solid #2a3b73;
      margin: clamp(8px, 2vw, 12px) 0;
      position: relative;
      background: #0f1730;
      flex-shrink: 0;
    }
    .landmark-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    .landmark-container:hover .landmark-img {
      transform: scale(1.05);
    }
    .landmark-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 20px 12px 10px;
      font-size: 13px;
      font-weight: 500;
    }
    .landmark-label .icon {
      margin-right: 6px;
    }

    /* Map styles */
    .map-container {
      width: 100%;
      height: clamp(250px, 50vh, 450px);
      border-radius: clamp(10px, 2vw, 16px);
      overflow: hidden;
      border: 2px solid #2a3b73;
      margin-bottom: clamp(10px, 2vw, 16px);
      flex-shrink: 0;
    }
    #gameMap { width: 100%; height: 100%; }

    /* Custom map markers */
    .custom-marker {
      background: none;
      border: none;
    }
    .marker-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .marker-dot.unvisited { background: #64748b; }
    .marker-dot.visited { background: #1fd18b; }
    .marker-dot.current { background: #ffd700; animation: pulse 1s ease-in-out infinite; }
    .marker-dot.start { background: #2b63ff; width: 26px; height: 26px; }
    .marker-dot.artifact { background: #ff6b6b; }

    .avatar-marker {
      font-size: 32px;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
      transition: all 0.5s ease-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
      50% { transform: scale(1.2); box-shadow: 0 0 20px rgba(255,215,0,0.6); }
    }

    /* Sewer animation */
    .sewer-scene {
      background: #0a0a0a;
      border-radius: clamp(8px, 2vw, 12px);
      padding: clamp(12px, 3vw, 20px);
      text-align: center;
      position: relative;
      overflow: hidden;
      min-height: clamp(220px, 40vh, 320px);
      flex: 1;
    }
    .sewer-tunnel {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 100%;
      background:
        /* Brick pattern overlay */
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 8px,
          rgba(0,0,0,0.3) 8px,
          rgba(0,0,0,0.3) 10px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 20px,
          rgba(0,0,0,0.2) 20px,
          rgba(0,0,0,0.2) 22px
        ),
        /* Tunnel gradient - darker at edges */
        radial-gradient(ellipse 60% 100% at 50% 50%, #3d2b1f 0%, #2a1f16 40%, #1a120c 70%, #0a0a0a 100%);
    }
    .sewer-pipe {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(ellipse at center, #0f0f0f 0%, #1a1a1a 60%, #333 80%, #555 90%, #444 100%);
      box-shadow:
        inset 0 0 30px rgba(0,0,0,0.8),
        0 0 20px rgba(0,0,0,0.6);
      border: 8px solid #555;
    }
    .sewer-pipe::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: radial-gradient(ellipse at center, #000 0%, #111 100%);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.9);
    }
    .sewer-water {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(180deg, rgba(26,58,92,0.3) 0%, rgba(26,58,92,0.8) 100%);
      overflow: hidden;
    }
    .sewer-water::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 300%;
      height: 100%;
      background: repeating-linear-gradient(
        90deg,
        rgba(45,90,123,0.6) 0px,
        rgba(26,58,92,0.4) 30px,
        rgba(45,90,123,0.6) 60px
      );
      animation: water-flow 3s linear infinite;
    }
    .sewer-drip {
      position: absolute;
      width: 4px;
      height: 12px;
      background: linear-gradient(180deg, rgba(100,150,200,0.8), rgba(60,100,140,0.4));
      border-radius: 50%;
      animation: drip 2s ease-in infinite;
    }
    .sewer-drip:nth-child(1) { left: 15%; animation-delay: 0s; }
    .sewer-drip:nth-child(2) { left: 35%; animation-delay: 0.7s; }
    .sewer-drip:nth-child(3) { left: 65%; animation-delay: 1.4s; }
    .sewer-drip:nth-child(4) { left: 85%; animation-delay: 0.3s; }
    @keyframes drip {
      0% { top: 10%; opacity: 1; }
      80% { top: 85%; opacity: 0.6; }
      100% { top: 90%; opacity: 0; }
    }
    @keyframes water-flow {
      0% { transform: translateX(0); }
      100% { transform: translateX(33.33%); }
    }
    .sewer-content {
      position: relative;
      z-index: 10;
      padding-top: 200px;
    }
    .sewer-sprite-container {
      position: absolute;
      top: 55px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5;
    }

    /* Fact card auto-advance */
    .fact-timer {
      height: 4px;
      background: #1fd18b;
      border-radius: 2px;
      margin-top: 12px;
      animation: shrink 4s linear forwards;
    }
    @keyframes shrink {
      from { width: 100%; }
      to { width: 0%; }
    }

    /* Artifact found animation */
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.5); }
      50% { box-shadow: 0 0 40px rgba(255,215,0,0.8); }
    }
    .artifact-found {
      animation: glow 2s ease-in-out infinite;
      background: linear-gradient(135deg, #2a2a4a 0%, #1a1a3a 100%);
    }

    /* Town scene backgrounds */
    .scene-urban { background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%); }
    .scene-rural { background: linear-gradient(135deg, #1a2e1a 0%, #2d3d2d 100%); }
    .scene-historic { background: linear-gradient(135deg, #2e1a1a 0%, #3d2d2d 100%); }
    .scene-lake { background: linear-gradient(135deg, #1a2e3e 0%, #2d4d5d 100%); }

    /* Audio controls */
    .audio-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .audio-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid #2a3b73;
      background: #0f1730;
      color: #e9eefc;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }
    .audio-btn:hover {
      background: #1a2744;
      border-color: #4e7bff;
    }
    .audio-btn.muted {
      opacity: 0.5;
      color: #ff5b6b;
    }
    .audio-btn.active {
      background: #1fd18b;
      border-color: #1fd18b;
      color: #0b1020;
    }

    /* Speaking indicator */
    .speaking-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(31,209,139,0.2);
      border-radius: 12px;
      font-size: 12px;
      color: #1fd18b;
    }
    .speaking-indicator .dot {
      width: 6px;
      height: 6px;
      background: #1fd18b;
      border-radius: 50%;
      animation: pulse-dot 1s ease-in-out infinite;
    }
    .speaking-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
    .speaking-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse-dot {
      0%, 100% { opacity: 0.3; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    /* Intro animation */
    .intro-title {
      font-size: clamp(1.5em, 5vw, 2.5em);
      text-align: center;
      margin-bottom: clamp(4px, 1vw, 8px);
      background: linear-gradient(135deg, #ffd700 0%, #ff6b6b 50%, #2b63ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 3s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    .intro-subtitle {
      text-align: center;
      font-size: clamp(0.9em, 2.5vw, 1.1em);
      opacity: 0.8;
      margin-bottom: clamp(12px, 3vw, 20px);
    }

    /* Tunnel Mini-Game */
    .tunnel-game {
      position: relative;
      width: 100%;
      height: min(50vh, 400px);
      min-height: 250px;
      background: linear-gradient(180deg, #1a1008 0%, #2d1810 50%, #1a1008 100%);
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #3d2b1f;
    }
    @media (min-height: 700px) {
      .tunnel-game {
        height: min(55vh, 450px);
      }
    }
    @media (min-height: 900px) {
      .tunnel-game {
        height: min(50vh, 500px);
      }
    }
    .tunnel-game-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 200%;
      height: 100%;
      background:
        repeating-linear-gradient(90deg, transparent 0px, transparent 60px, rgba(0,0,0,0.3) 60px, rgba(0,0,0,0.3) 62px),
        repeating-linear-gradient(0deg, transparent 0px, transparent 30px, rgba(0,0,0,0.2) 30px, rgba(0,0,0,0.2) 32px);
      animation: tunnel-scroll 2s linear infinite;
    }
    @keyframes tunnel-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .tunnel-floor {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: linear-gradient(180deg, #3d2b1f 0%, #2a1f16 100%);
      border-top: 3px solid #4d3b2f;
    }
    .tunnel-water {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: rgba(26,58,92,0.5);
      overflow: hidden;
    }
    .tunnel-player {
      position: absolute;
      bottom: 70px;
      width: clamp(48px, 14%, 72px);
      height: clamp(48px, 14%, 72px);
      transition: left 0.1s, bottom 0.05s;
      z-index: 10;
    }
    .tunnel-player img {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }
    .tunnel-coin {
      position: absolute;
      width: clamp(24px, 8%, 36px);
      height: clamp(24px, 8%, 36px);
      font-size: clamp(22px, 6vw, 32px);
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: coin-bounce 0.5s ease-in-out infinite alternate;
      z-index: 5;
      transition: transform 0.2s, opacity 0.2s;
    }
    .tunnel-coin.collected {
      transform: scale(1.5);
      opacity: 0;
    }
    @keyframes coin-bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-8px); }
    }
    .tunnel-npc {
      position: absolute;
      bottom: 70px;
      left: 85%;
      width: clamp(48px, 14%, 72px);
      height: clamp(48px, 14%, 72px);
      z-index: 8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(36px, 10vw, 56px);
    }
    .tunnel-npc img {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }
    .tunnel-speech {
      position: absolute;
      bottom: clamp(130px, 35%, 160px);
      left: 75%;
      background: white;
      color: #333;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: clamp(11px, 2.5vw, 14px);
      max-width: min(120px, 25%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tunnel-speech.visible {
      opacity: 1;
    }
    .tunnel-speech::after {
      content: '';
      position: absolute;
      bottom: -8px;
      right: 20px;
      border: 8px solid transparent;
      border-top-color: white;
      border-bottom: 0;
    }
    .tunnel-hud {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: space-between;
      z-index: 20;
    }
    .tunnel-coins-display {
      background: rgba(0,0,0,0.6);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      color: #ffd700;
    }
    .tunnel-instructions {
      background: rgba(0,0,0,0.6);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #aaa;
    }
    .tunnel-skip-btn {
      background: rgba(255,91,107,0.8);
      border: none;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .tunnel-skip-btn:hover {
      background: rgba(255,91,107,1);
      transform: scale(1.05);
    }

    /* Leaderboard */
    .leaderboard {
      background: linear-gradient(135deg, #1a2744 0%, #0f1730 100%);
      border: 2px solid #2a3b73;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }
    .leaderboard h3 {
      margin: 0 0 12px;
      text-align: center;
      color: #ffd700;
    }
    .leaderboard-list {
      max-height: 250px;
      overflow-y: auto;
    }
    .leaderboard-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .leaderboard-entry.highlight {
      background: rgba(31,209,139,0.2);
      border: 1px solid #1fd18b;
    }
    .leaderboard-rank {
      font-weight: bold;
      color: #ffd700;
      min-width: 28px;
    }
    .leaderboard-rank.gold { color: #ffd700; }
    .leaderboard-rank.silver { color: #c0c0c0; }
    .leaderboard-rank.bronze { color: #cd7f32; }
    .leaderboard-name {
      flex: 1;
      font-weight: 500;
    }
    .leaderboard-class {
      opacity: 0.7;
      font-size: 12px;
    }
    .leaderboard-score {
      font-weight: bold;
      color: #1fd18b;
    }
    .leaderboard-coins {
      color: #ffd700;
      font-size: 12px;
    }
    .leaderboard-form {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .leaderboard-form input {
      flex: 1;
      min-width: 100px;
    }
    .leaderboard-form button {
      white-space: nowrap;
    }

    /* Responsive adjustments for small screens */
    @media (max-width: 480px) {
      .topbar {
        flex-wrap: wrap;
        gap: 6px;
      }
      .progress {
        order: 3;
        flex-basis: 100%;
        min-width: unset;
      }
      .audio-controls {
        margin-left: auto;
      }
      h1, h2 {
        font-size: clamp(1.1em, 4vw, 1.5em);
      }
      .hoosier-portrait {
        width: 60px;
        height: 60px;
      }
      .hoosier-card .name {
        font-size: 11px;
      }
      .hoosier-card .title {
        font-size: 9px;
      }
      .leaderboard-entry {
        flex-wrap: wrap;
        gap: 6px;
        font-size: 12px;
      }
      .leaderboard-form {
        flex-direction: column;
      }
      .leaderboard-form input,
      .leaderboard-form select {
        width: 100%;
      }
    }

    /* Very small screens */
    @media (max-height: 500px) {
      .wrap {
        padding: 8px;
      }
      .card {
        padding: 10px;
      }
      .map-container {
        height: 35vh;
        min-height: 180px;
      }
      .tunnel-game {
        height: 35vh;
        min-height: 200px;
      }
      .sewer-scene {
        min-height: 180px;
      }
    }

    /* Landscape orientation */
    @media (max-height: 450px) and (orientation: landscape) {
      .topbar {
        margin-bottom: 6px;
      }
      .wrap {
        padding: 6px 12px;
      }
      .card {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pill" id="statusPill">Not started</div>
      <div class="progress" aria-label="progress"><div id="progressBar"></div></div>
      <div class="pill" id="scorePill">Score: 0</div>
      <div class="audio-controls">
        <button class="audio-btn" id="voiceBtn" title="Toggle narration">üó£Ô∏è</button>
        <button class="audio-btn" id="musicBtn" title="Toggle music">üéµ</button>
      </div>
    </div>
    <div style="height:14px"></div>

    <div class="card" id="app"></div>

    <div style="height:12px"></div>
    <div class="row">
      <button class="btn secondary" id="resetBtn">Reset Game</button>
    </div>
  </div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ==========================================
// AUDIO SYSTEM - Speech Synthesis & Music
// ==========================================

const AudioSystem = {
  // Settings
  voiceEnabled: true,
  musicEnabled: true,
  currentMusic: null,
  isSpeaking: false,
  speechQueue: [],

  // Music tracks (using Web Audio API for generated music)
  audioContext: null,
  musicGainNode: null,
  currentOscillators: [],

  init() {
    try {
      // Initialize Web Audio API
      const AudioContextClass = window.AudioContext || window.webkitAudioContext;
      if (AudioContextClass) {
        this.audioContext = new AudioContextClass();
        this.musicGainNode = this.audioContext.createGain();
        this.musicGainNode.connect(this.audioContext.destination);
        this.musicGainNode.gain.value = 0.15; // Lower volume for background music
      }
    } catch (e) {
      console.warn('Web Audio API not available:', e);
    }

    // Set up UI controls
    this.setupControls();

    // Load saved preferences
    const savedVoice = localStorage.getItem('aviGame_voiceEnabled');
    const savedMusic = localStorage.getItem('aviGame_musicEnabled');
    if (savedVoice !== null) this.voiceEnabled = savedVoice === 'true';
    if (savedMusic !== null) this.musicEnabled = savedMusic === 'true';
    this.updateButtons();
  },

  setupControls() {
    const voiceBtn = document.getElementById('voiceBtn');
    const musicBtn = document.getElementById('musicBtn');

    if (voiceBtn) {
      voiceBtn.onclick = () => this.toggleVoice();
    }
    if (musicBtn) {
      musicBtn.onclick = () => this.toggleMusic();
    }
  },

  toggleVoice() {
    this.voiceEnabled = !this.voiceEnabled;
    localStorage.setItem('aviGame_voiceEnabled', this.voiceEnabled);
    this.updateButtons();
    if (!this.voiceEnabled) {
      this.stopSpeaking();
    }
  },

  toggleMusic() {
    this.musicEnabled = !this.musicEnabled;
    localStorage.setItem('aviGame_musicEnabled', this.musicEnabled);
    this.updateButtons();
    if (!this.musicEnabled) {
      this.stopMusic();
    }
  },

  updateButtons() {
    const voiceBtn = document.getElementById('voiceBtn');
    const musicBtn = document.getElementById('musicBtn');

    if (voiceBtn) {
      voiceBtn.classList.toggle('muted', !this.voiceEnabled);
      voiceBtn.textContent = this.voiceEnabled ? 'üó£Ô∏è' : 'üîá';
    }
    if (musicBtn) {
      musicBtn.classList.toggle('muted', !this.musicEnabled);
      musicBtn.textContent = this.musicEnabled ? 'üéµ' : 'üîá';
    }
  },

  // Text-to-Speech narration
  speak(text, options = {}) {
    if (!this.voiceEnabled || !('speechSynthesis' in window)) return;

    // Cancel any ongoing speech
    this.stopSpeaking();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = options.rate || 0.95;
    utterance.pitch = options.pitch || 1;
    utterance.volume = options.volume || 0.9;

    // Try to use a good voice
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(v =>
      v.name.includes('Google') ||
      v.name.includes('Samantha') ||
      v.name.includes('Daniel') ||
      v.lang.startsWith('en')
    ) || voices[0];

    if (preferredVoice) {
      utterance.voice = preferredVoice;
    }

    utterance.onstart = () => {
      this.isSpeaking = true;
    };

    utterance.onend = () => {
      this.isSpeaking = false;
    };

    utterance.onerror = () => {
      this.isSpeaking = false;
    };

    speechSynthesis.speak(utterance);
  },

  stopSpeaking() {
    if ('speechSynthesis' in window) {
      speechSynthesis.cancel();
    }
    this.isSpeaking = false;
  },

  // Music Generation using Web Audio API
  playMusic(type = 'adventure') {
    if (!this.musicEnabled || !this.audioContext) return;

    // Resume audio context if suspended (browser autoplay policy)
    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume();
    }

    this.stopMusic();

    switch (type) {
      case 'adventure':
        this.playAdventureMusic();
        break;
      case 'sewer':
        this.playSewerAmbience();
        break;
      case 'victory':
        this.playVictoryFanfare();
        break;
      case 'intro':
        this.playIntroMusic();
        break;
      case 'walking':
        this.playWalkingMusic();
        break;
      default:
        this.playAdventureMusic();
    }

    this.currentMusic = type;
  },

  stopMusic() {
    if (this.currentOscillators) {
      this.currentOscillators.forEach(osc => {
        try {
          osc.stop();
          osc.disconnect();
        } catch (e) {}
      });
      this.currentOscillators = [];
    }
    this.currentMusic = null;
  },

  // Adventure/exploration music - upbeat and curious
  playAdventureMusic() {
    const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 349.23, 329.63, 293.66]; // C major scale melody
    this.playMelodyLoop(notes, 0.3, 'sine');
  },

  // Walking music - rhythmic and steady
  playWalkingMusic() {
    const notes = [196, 220, 247, 262, 294, 262, 247, 220]; // G major walking bass
    this.playMelodyLoop(notes, 0.25, 'triangle');
  },

  // Sewer ambience - dark, echoing, and mysterious
  playSewerAmbience() {
    // Create a reverb-like effect using delays
    const createEcho = (source, delayTime, feedback) => {
      const delay = this.audioContext.createDelay();
      const feedbackGain = this.audioContext.createGain();
      delay.delayTime.value = delayTime;
      feedbackGain.gain.value = feedback;
      source.connect(delay);
      delay.connect(feedbackGain);
      feedbackGain.connect(delay);
      delay.connect(this.musicGainNode);
      return delay;
    };

    // Deep rumbling bass drone
    const bassDrone = this.audioContext.createOscillator();
    bassDrone.type = 'sawtooth';
    bassDrone.frequency.value = 40; // Very low
    const bassGain = this.audioContext.createGain();
    bassGain.gain.value = 0.04;

    // LFO for bass wobble
    const bassLfo = this.audioContext.createOscillator();
    bassLfo.frequency.value = 0.3;
    const bassLfoGain = this.audioContext.createGain();
    bassLfoGain.gain.value = 5;
    bassLfo.connect(bassLfoGain);
    bassLfoGain.connect(bassDrone.frequency);

    bassDrone.connect(bassGain);
    bassGain.connect(this.musicGainNode);
    bassDrone.start();
    bassLfo.start();

    // Eerie mid-frequency drone with slow modulation
    const midDrone = this.audioContext.createOscillator();
    midDrone.type = 'sine';
    midDrone.frequency.value = 110;
    const midGain = this.audioContext.createGain();
    midGain.gain.value = 0.02;

    const midLfo = this.audioContext.createOscillator();
    midLfo.frequency.value = 0.1;
    const midLfoGain = this.audioContext.createGain();
    midLfoGain.gain.value = 8;
    midLfo.connect(midLfoGain);
    midLfoGain.connect(midDrone.frequency);

    midDrone.connect(midGain);
    midGain.connect(this.musicGainNode);
    midDrone.start();
    midLfo.start();

    // Filtered noise for water/wind ambience
    const noiseBuffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 2, this.audioContext.sampleRate);
    const noiseData = noiseBuffer.getChannelData(0);
    for (let i = 0; i < noiseData.length; i++) {
      noiseData[i] = Math.random() * 2 - 1;
    }
    const noiseSource = this.audioContext.createBufferSource();
    noiseSource.buffer = noiseBuffer;
    noiseSource.loop = true;

    // Low-pass filter for muffled water sound
    const noiseFilter = this.audioContext.createBiquadFilter();
    noiseFilter.type = 'lowpass';
    noiseFilter.frequency.value = 400;
    noiseFilter.Q.value = 1;

    // Modulate the filter for movement
    const filterLfo = this.audioContext.createOscillator();
    filterLfo.frequency.value = 0.15;
    const filterLfoGain = this.audioContext.createGain();
    filterLfoGain.gain.value = 200;
    filterLfo.connect(filterLfoGain);
    filterLfoGain.connect(noiseFilter.frequency);

    const noiseGain = this.audioContext.createGain();
    noiseGain.gain.value = 0.03;

    noiseSource.connect(noiseFilter);
    noiseFilter.connect(noiseGain);
    noiseGain.connect(this.musicGainNode);
    noiseSource.start();
    filterLfo.start();

    // Tracker oscillator for loop management
    const tracker = this.audioContext.createOscillator();
    tracker.frequency.value = 0;
    this.currentOscillators.push(bassDrone, bassLfo, midDrone, midLfo, noiseSource, filterLfo, tracker);

    // Schedule atmospheric drips with echoes
    this.scheduleDrips();

    // Schedule occasional distant rumbles
    this.scheduleRumbles();
  },

  scheduleDrips() {
    if (!this.musicEnabled || this.currentMusic !== 'sewer') return;

    const dripDelay = 800 + Math.random() * 2500;
    setTimeout(() => {
      if (this.currentMusic === 'sewer') {
        this.playDrip();
        this.scheduleDrips();
      }
    }, dripDelay);
  },

  scheduleRumbles() {
    if (!this.musicEnabled || this.currentMusic !== 'sewer') return;

    const rumbleDelay = 4000 + Math.random() * 6000;
    setTimeout(() => {
      if (this.currentMusic === 'sewer') {
        this.playDistantRumble();
        this.scheduleRumbles();
      }
    }, rumbleDelay);
  },

  playDrip() {
    if (!this.musicEnabled || !this.audioContext) return;

    const time = this.audioContext.currentTime;

    // Main drip - high frequency ping
    const osc = this.audioContext.createOscillator();
    const gain = this.audioContext.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(1200 + Math.random() * 600, time);
    osc.frequency.exponentialRampToValueAtTime(600 + Math.random() * 200, time + 0.15);

    gain.gain.setValueAtTime(0.08, time);
    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);

    osc.connect(gain);
    gain.connect(this.musicGainNode);
    osc.start(time);
    osc.stop(time + 0.2);

    // Echo/splash effect
    if (Math.random() > 0.3) {
      const echo = this.audioContext.createOscillator();
      const echoGain = this.audioContext.createGain();
      echo.type = 'sine';
      echo.frequency.value = 400 + Math.random() * 300;

      echoGain.gain.setValueAtTime(0.03, time + 0.1);
      echoGain.gain.exponentialRampToValueAtTime(0.001, time + 0.4);

      echo.connect(echoGain);
      echoGain.connect(this.musicGainNode);
      echo.start(time + 0.1);
      echo.stop(time + 0.4);
    }
  },

  playDistantRumble() {
    if (!this.musicEnabled || !this.audioContext) return;

    const time = this.audioContext.currentTime;
    const duration = 1.5 + Math.random();

    // Low frequency rumble
    const rumble = this.audioContext.createOscillator();
    rumble.type = 'sawtooth';
    rumble.frequency.value = 30 + Math.random() * 20;

    const rumbleGain = this.audioContext.createGain();
    rumbleGain.gain.setValueAtTime(0, time);
    rumbleGain.gain.linearRampToValueAtTime(0.04, time + 0.3);
    rumbleGain.gain.linearRampToValueAtTime(0.02, time + duration * 0.7);
    rumbleGain.gain.exponentialRampToValueAtTime(0.001, time + duration);

    // Filter to make it more muffled
    const filter = this.audioContext.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 150;

    rumble.connect(filter);
    filter.connect(rumbleGain);
    rumbleGain.connect(this.musicGainNode);

    rumble.start(time);
    rumble.stop(time + duration);
  },

  // Victory fanfare
  playVictoryFanfare() {
    const notes = [392, 494, 587, 784, 659, 784]; // Victory melody
    const durations = [0.2, 0.2, 0.2, 0.4, 0.2, 0.6];

    let time = this.audioContext.currentTime;

    notes.forEach((freq, i) => {
      const osc = this.audioContext.createOscillator();
      const gain = this.audioContext.createGain();

      osc.type = 'square';
      osc.frequency.value = freq;

      gain.gain.setValueAtTime(0.15, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + durations[i]);

      osc.connect(gain);
      gain.connect(this.musicGainNode);

      osc.start(time);
      osc.stop(time + durations[i]);

      time += durations[i] * 0.8;
    });
  },

  // Intro music - majestic and inviting
  playIntroMusic() {
    const notes = [262, 330, 392, 523, 392, 330, 262, 196]; // C major arpeggio
    this.playMelodyLoop(notes, 0.4, 'sine');
  },

  // Helper to play a looping melody
  playMelodyLoop(notes, noteDuration, waveType) {
    let noteIndex = 0;

    const playNote = () => {
      if (!this.musicEnabled || this.currentOscillators.length === 0) return;

      const osc = this.audioContext.createOscillator();
      const gain = this.audioContext.createGain();

      osc.type = waveType;
      osc.frequency.value = notes[noteIndex];

      gain.gain.setValueAtTime(0.1, this.audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + noteDuration * 0.9);

      osc.connect(gain);
      gain.connect(this.musicGainNode);

      osc.start();
      osc.stop(this.audioContext.currentTime + noteDuration);

      noteIndex = (noteIndex + 1) % notes.length;
    };

    // Create a dummy oscillator to track the loop
    const tracker = this.audioContext.createOscillator();
    tracker.frequency.value = 0;
    this.currentOscillators.push(tracker);

    // Play notes in a loop
    const interval = setInterval(() => {
      if (!this.musicEnabled || !this.currentOscillators.includes(tracker)) {
        clearInterval(interval);
        return;
      }
      playNote();
    }, noteDuration * 1000);

    // Play first note immediately
    playNote();
  },

  // Sound effects
  playSound(type) {
    if (!this.musicEnabled || !this.audioContext) return;

    if (this.audioContext.state === 'suspended') {
      this.audioContext.resume();
    }

    switch (type) {
      case 'click':
        this.playClickSound();
        break;
      case 'correct':
        this.playCorrectSound();
        break;
      case 'wrong':
        this.playWrongSound();
        break;
      case 'artifact':
        this.playArtifactSound();
        break;
    }
  },

  playClickSound() {
    const osc = this.audioContext.createOscillator();
    const gain = this.audioContext.createGain();

    osc.type = 'sine';
    osc.frequency.value = 800;

    gain.gain.setValueAtTime(0.2, this.audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.1);

    osc.connect(gain);
    gain.connect(this.audioContext.destination);

    osc.start();
    osc.stop(this.audioContext.currentTime + 0.1);
  },

  playCorrectSound() {
    const frequencies = [523, 659, 784]; // C-E-G chord
    frequencies.forEach((freq, i) => {
      setTimeout(() => {
        const osc = this.audioContext.createOscillator();
        const gain = this.audioContext.createGain();

        osc.type = 'sine';
        osc.frequency.value = freq;

        gain.gain.setValueAtTime(0.15, this.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.3);

        osc.connect(gain);
        gain.connect(this.audioContext.destination);

        osc.start();
        osc.stop(this.audioContext.currentTime + 0.3);
      }, i * 100);
    });
  },

  playWrongSound() {
    // Kid-friendly "uh-oh" sound - gentle descending tones
    const time = this.audioContext.currentTime;

    // First note - higher "uh"
    const osc1 = this.audioContext.createOscillator();
    const gain1 = this.audioContext.createGain();
    osc1.type = 'sine';
    osc1.frequency.value = 440;
    gain1.gain.setValueAtTime(0.12, time);
    gain1.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
    osc1.connect(gain1);
    gain1.connect(this.audioContext.destination);
    osc1.start(time);
    osc1.stop(time + 0.2);

    // Second note - lower "oh"
    const osc2 = this.audioContext.createOscillator();
    const gain2 = this.audioContext.createGain();
    osc2.type = 'sine';
    osc2.frequency.value = 330;
    gain2.gain.setValueAtTime(0.12, time + 0.15);
    gain2.gain.exponentialRampToValueAtTime(0.001, time + 0.45);
    osc2.connect(gain2);
    gain2.connect(this.audioContext.destination);
    osc2.start(time + 0.15);
    osc2.stop(time + 0.45);
  },

  playArtifactSound() {
    // Magical discovery sound
    const notes = [523, 659, 784, 1047, 784, 1047, 1319];
    let time = this.audioContext.currentTime;

    notes.forEach((freq, i) => {
      const osc = this.audioContext.createOscillator();
      const gain = this.audioContext.createGain();

      osc.type = 'sine';
      osc.frequency.value = freq;

      gain.gain.setValueAtTime(0.12, time);
      gain.gain.exponentialRampToValueAtTime(0.001, time + 0.25);

      osc.connect(gain);
      gain.connect(this.audioContext.destination);

      osc.start(time);
      osc.stop(time + 0.25);

      time += 0.12;
    });
  }
};

// Initialize audio system immediately (script is at bottom of body, so DOM is ready)
AudioSystem.init();

// Also try to resume on first user interaction (for autoplay policy)
document.addEventListener('click', () => {
  if (AudioSystem.audioContext && AudioSystem.audioContext.state === 'suspended') {
    AudioSystem.audioContext.resume();
  }
}, { once: true });

/**
 * INDIANA TREASURE QUEST
 * Route based on the map: Indianapolis -> East -> North -> Angola (artifact) -> West along top -> South -> Back to Indianapolis
 */

// Real GPS coordinates for Indiana towns
const townCoords = {
  "Indianapolis": { lat: 39.7684, lng: -86.1581 },
  "Shelbyville": { lat: 39.5214, lng: -85.7769 },
  "Richmond": { lat: 39.8289, lng: -84.8902 },
  "New Castle": { lat: 39.9289, lng: -85.3700 },
  "Muncie": { lat: 40.1934, lng: -85.3864 },
  "Marion": { lat: 40.5584, lng: -85.6591 },
  "Huntington": { lat: 40.8831, lng: -85.4975 },
  "Fort Wayne": { lat: 41.0793, lng: -85.1394 },
  "Angola": { lat: 41.6348, lng: -84.9994 },
  "Elkhart": { lat: 41.6820, lng: -85.9767 },
  "South Bend": { lat: 41.6764, lng: -86.2520 },
  "La Porte": { lat: 41.6106, lng: -86.7225 },
  "Michigan City": { lat: 41.7075, lng: -86.8950 },
  "Gary": { lat: 41.5934, lng: -87.3464 },
  "Hammond": { lat: 41.5833, lng: -87.5000 },
  "Logansport": { lat: 40.7545, lng: -86.3567 },
  "Lafayette": { lat: 40.4167, lng: -86.8753 },
  "Kokomo": { lat: 40.4864, lng: -86.1336 },
  "Terre Haute": { lat: 39.4667, lng: -87.4139 },
  "Bloomington": { lat: 39.1653, lng: -86.5264 },
  "Vincennes": { lat: 38.6773, lng: -87.5286 },
  "Washington": { lat: 38.6592, lng: -87.1728 },
  "Evansville": { lat: 37.9716, lng: -87.5711 },
  "New Albany": { lat: 38.2856, lng: -85.8241 },
  "Bedford": { lat: 38.8612, lng: -86.4872 },
  "Seymour": { lat: 38.9592, lng: -85.8903 },
  "Columbus": { lat: 39.2014, lng: -85.9214 }
};

// Famous landmarks in each town with Wikimedia Commons images
const townLandmarks = {
  "Indianapolis": {
    name: "Indianapolis Motor Speedway",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Indianapolis_Motor_Speedway_Aerial.jpg/1280px-Indianapolis_Motor_Speedway_Aerial.jpg"
  },
  "Bloomington": {
    name: "Indiana University Sample Gates",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/Indiana_University_Sample_Gates.jpg/1280px-Indiana_University_Sample_Gates.jpg"
  },
  "Vincennes": {
    name: "George Rogers Clark Memorial",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/George_Rogers_Clark_Memorial_-_Vincennes%2C_Indiana.jpg/1280px-George_Rogers_Clark_Memorial_-_Vincennes%2C_Indiana.jpg"
  },
  "Washington": {
    name: "Daviess County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Daviess_County_Courthouse%2C_Washington.jpg/1024px-Daviess_County_Courthouse%2C_Washington.jpg"
  },
  "Evansville": {
    name: "USS LST-325 Ship Memorial",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/USS_LST-325.jpg/1280px-USS_LST-325.jpg"
  },
  "New Albany": {
    name: "Falls of the Ohio",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Falls_of_the_Ohio_-_Fossil_Beds.jpg/1280px-Falls_of_the_Ohio_-_Fossil_Beds.jpg"
  },
  "Bedford": {
    name: "Bedford Courthouse Square",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Lawrence_County_Courthouse%2C_Bedford.jpg/1024px-Lawrence_County_Courthouse%2C_Bedford.jpg"
  },
  "Seymour": {
    name: "John Mellencamp Mural",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/Jackson_County_Courthouse_in_Brownstown.jpg/1024px-Jackson_County_Courthouse_in_Brownstown.jpg"
  },
  "Columbus": {
    name: "Miller House and Garden",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Columbus-indiana-architecture-702702730-702702730.jpg/1280px-Columbus-indiana-architecture-702702730-702702730.jpg"
  },
  "Shelbyville": {
    name: "Shelby County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Shelby_County_Courthouse%2C_Shelbyville.jpg/1024px-Shelby_County_Courthouse%2C_Shelbyville.jpg"
  },
  "Richmond": {
    name: "Wayne County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Wayne_County_Indiana_Courthouse.jpg/1024px-Wayne_County_Indiana_Courthouse.jpg"
  },
  "New Castle": {
    name: "New Castle Fieldhouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/New_Castle_Chrysler_High_School_Fieldhouse.jpg/1280px-New_Castle_Chrysler_High_School_Fieldhouse.jpg"
  },
  "Muncie": {
    name: "Ball State University",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Beneficence_statue%2C_Ball_State_University.jpg/1024px-Beneficence_statue%2C_Ball_State_University.jpg"
  },
  "Marion": {
    name: "James Dean Memorial",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/James_Dean_Gallery_in_Fairmount%2C_Indiana.jpg/1024px-James_Dean_Gallery_in_Fairmount%2C_Indiana.jpg"
  },
  "Huntington": {
    name: "Huntington County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Huntington_County_Courthouse.jpg/1024px-Huntington_County_Courthouse.jpg"
  },
  "Fort Wayne": {
    name: "Allen County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/Allen_County_Courthouse_Fort_Wayne.jpg/1024px-Allen_County_Courthouse_Fort_Wayne.jpg"
  },
  "Angola": {
    name: "Pokagon State Park",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/Pokagon_State_Park_Lake_James.jpg/1280px-Pokagon_State_Park_Lake_James.jpg"
  },
  "Elkhart": {
    name: "RV/MH Hall of Fame",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a3/RV-MH_Hall_of_Fame_front.JPG/1280px-RV-MH_Hall_of_Fame_front.JPG"
  },
  "South Bend": {
    name: "Notre Dame Golden Dome",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/Golden_dome_2023.jpg/1024px-Golden_dome_2023.jpg"
  },
  "La Porte": {
    name: "La Porte County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/La_Porte_County_Courthouse.jpg/1024px-La_Porte_County_Courthouse.jpg"
  },
  "Michigan City": {
    name: "Michigan City Lighthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/99/Michigan_City_Light_in_2013.JPG/1024px-Michigan_City_Light_in_2013.JPG"
  },
  "Gary": {
    name: "Gary Aquatorium",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Aquatorium_Gary_Indiana.jpg/1280px-Aquatorium_Gary_Indiana.jpg"
  },
  "Hammond": {
    name: "Wolf Lake Pavilion",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/Hammond_Indiana_City_Hall.jpg/1024px-Hammond_Indiana_City_Hall.jpg"
  },
  "Logansport": {
    name: "Cass County Carousel",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Cass_County_Carousel_2020.jpg/1280px-Cass_County_Carousel_2020.jpg"
  },
  "Lafayette": {
    name: "Purdue University",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Purdue_University%2C_West_Lafayette%2C_Indiana%2C_Estados_Unidos%2C_2012-10-15%2C_DD_17.jpg/1280px-Purdue_University%2C_West_Lafayette%2C_Indiana%2C_Estados_Unidos%2C_2012-10-15%2C_DD_17.jpg"
  },
  "Kokomo": {
    name: "Elwood Haynes Museum",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Elwood_Haynes_Museum.jpg/1024px-Elwood_Haynes_Museum.jpg"
  },
  "Terre Haute": {
    name: "Vigo County Courthouse",
    image: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/Vigo_County_Courthouse%2C_Terre_Haute%2C_IN%2C_US_%282%29.jpg/1024px-Vigo_County_Courthouse%2C_Terre_Haute%2C_IN%2C_US_%282%29.jpg"
  }
};

// All 19 questions
const allQuestions = [
  {
    question: "Is it true that Indiana named many of its cities/towns after other places?",
    choices: ["Yes, many are named after places worldwide", "No, all names are original", "Only a few are named after other places", "Names come from Native American words only"],
    answerIndex: 0,
    fact: "Indiana has towns named after places like Peru, Brazil, Lebanon, and Versailles!"
  },
  {
    question: "What is Indiana's nickname?",
    choices: ["The Hoosier State", "The Buckeye State", "The Prairie State", "The Crossroads State"],
    answerIndex: 0,
    fact: "Indiana is proudly known as 'The Hoosier State.'"
  },
  {
    question: "What is Indiana's state motto?",
    choices: ["The Hoosier State", "Crossroads of America", "Land of the Free", "Gateway to the West"],
    answerIndex: 1,
    fact: "Indiana's motto is 'Crossroads of America' due to its central location and many highways."
  },
  {
    question: "In what year did Indiana become a state?",
    choices: ["1776", "1803", "1816", "1861"],
    answerIndex: 2,
    fact: "Indiana became the 19th U.S. state on December 11, 1816."
  },
  {
    question: "What is Indiana's state bird?",
    choices: ["Blue Jay", "Cardinal", "Robin", "Goldfinch"],
    answerIndex: 1,
    fact: "The bright red Northern Cardinal is Indiana's state bird since 1933."
  },
  {
    question: "What is the official state river of Indiana?",
    choices: ["Ohio River", "White River", "Wabash River", "Tippecanoe River"],
    answerIndex: 2,
    fact: "The Wabash River became Indiana's official state river in 1996."
  },
  {
    question: "What is the largest natural lake in Indiana?",
    choices: ["Lake Monroe", "Lake Wawasee", "Geist Reservoir", "Lake Michigan"],
    answerIndex: 1,
    fact: "Lake Wawasee in Kosciusko County is Indiana's largest natural lake at about 3,000 acres."
  },
  {
    question: "What is Indiana's state flower?",
    choices: ["Rose", "Tulip", "Peony", "Sunflower"],
    answerIndex: 2,
    fact: "The Peony has been Indiana's state flower since 1957."
  },
  {
    question: "Which Great Lake borders Indiana's northwest corner?",
    choices: ["Lake Superior", "Lake Michigan", "Lake Erie", "Lake Huron"],
    answerIndex: 1,
    fact: "Lake Michigan provides Indiana with beautiful beaches and a shipping port."
  },
  {
    question: "Which Indiana city was the first in the world to be lit by electric streetlights?",
    choices: ["Indianapolis", "Fort Wayne", "Wabash", "South Bend"],
    answerIndex: 2,
    fact: "On March 31, 1880, Wabash became the first electrically-lit city in the world!"
  },
  {
    question: "What famous race is held annually at the Indianapolis Motor Speedway?",
    choices: ["Daytona 500", "Indianapolis 500", "Monaco Grand Prix", "Kentucky Derby"],
    answerIndex: 1,
    fact: "The Indianapolis 500, first run in 1911, is one of the oldest and most prestigious auto races."
  },
  {
    question: "Which U.S. President grew up in Spencer County, Indiana?",
    choices: ["George Washington", "Thomas Jefferson", "Abraham Lincoln", "Theodore Roosevelt"],
    answerIndex: 2,
    fact: "Abraham Lincoln lived in Indiana from age 7 to 21, shaping his character and values."
  },
  {
    question: "Which Indiana town receives over half a million letters addressed to Santa every year?",
    choices: ["North Pole", "Christmas", "Santa Claus", "Holiday"],
    answerIndex: 2,
    fact: "Santa Claus, Indiana receives over 500,000 letters to Santa each holiday season!"
  },
  {
    question: "Where was the world's first professional baseball game played?",
    choices: ["New York City", "Boston", "Fort Wayne", "Chicago"],
    answerIndex: 2,
    fact: "On May 4, 1871, Fort Wayne hosted the first professional baseball game!"
  },
  {
    question: "Who is the 'King of Pop' who was born in Gary, Indiana?",
    choices: ["Prince", "Elvis Presley", "Michael Jackson", "Stevie Wonder"],
    answerIndex: 2,
    fact: "Michael Jackson was born in Gary, Indiana on August 29, 1958."
  },
  {
    question: "What snack food is Indiana a top producer of (over 20% of U.S. supply)?",
    choices: ["Potato chips", "Pretzels", "Popcorn", "Peanuts"],
    answerIndex: 2,
    fact: "Indiana grows more popcorn than any other state‚Äîover 20% of the nation's supply!"
  },
  {
    question: "What is Indiana's state fossil?",
    choices: ["Tyrannosaurus Rex", "Mastodon", "Trilobite", "Mammoth"],
    answerIndex: 1,
    fact: "The Mastodon became Indiana's state fossil in 2022. Many fossils have been found in the state."
  },
  {
    question: "What is Indiana's state insect?",
    choices: ["Monarch Butterfly", "Honeybee", "Say's Firefly", "Ladybug"],
    answerIndex: 2,
    fact: "Say's Firefly, named after naturalist Thomas Say who lived in New Harmony, is the state insect."
  },
  {
    question: "What is the world's largest children's museum, located in Indianapolis?",
    choices: ["Smithsonian Kids", "The Children's Museum of Indianapolis", "Discovery Place Kids", "Please Touch Museum"],
    answerIndex: 1,
    fact: "The Children's Museum of Indianapolis has over 120,000 artifacts and is the world's largest!"
  }
];

// 7 informational facts (no question, auto-advance)
const infoFacts = [
  "üèõÔ∏è Indiana's name means 'Land of the Indians' and was coined in the 1760s.",
  "üåΩ Indiana is part of the Corn Belt and is one of the top corn-producing states in the nation.",
  "üöó The first long-distance auto road in America, the Lincoln Highway, passes through Indiana.",
  "üé≠ New Harmony, Indiana was the site of two early American utopian communities in the 1800s.",
  "üèÄ Basketball is incredibly popular in Indiana‚Äîthe state has the largest high school gym in the U.S.!",
  "ü¶å Indiana has over 4.6 million acres of forested land, home to deer, wild turkeys, and more.",
  "‚öôÔ∏è Studebaker automobiles were manufactured in South Bend, Indiana from 1852 to 1966."
];

// Build the route (following the map path)
const routeOrder = [
  "Indianapolis",   // 0 - START
  "Bloomington",    // 1
  "Vincennes",      // 2
  "Washington",     // 3
  "Evansville",     // 4
  "New Albany",     // 5
  "Bedford",        // 6
  "Seymour",        // 7
  "Columbus",       // 8
  "Shelbyville",    // 9
  "Richmond",       // 10
  "New Castle",     // 11
  "Muncie",         // 12
  "Marion",         // 13
  "Huntington",     // 14
  "Fort Wayne",     // 15
  "Angola",         // 16 - ARTIFACT HERE
  "Elkhart",        // 17
  "South Bend",     // 18
  "La Porte",       // 19
  "Michigan City",  // 20
  "Gary",           // 21
  "Hammond",        // 22
  "Logansport",     // 23
  "Lafayette",      // 24
  "Kokomo",         // 25
  "Terre Haute",    // 26
  "Indianapolis"    // 27 - END
];

const ARTIFACT_INDEX = 16; // Angola

// Shuffle function
function shuffle(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Build towns array with randomized questions/facts
function buildTownsArray() {
  const towns = [];
  const questionIndices = new Set();
  const availableIndices = [];

  for (let i = 1; i <= 26; i++) {
    availableIndices.push(i);
  }

  const shuffledIndices = shuffle(availableIndices);
  for (let i = 0; i < 19; i++) {
    questionIndices.add(shuffledIndices[i]);
  }

  const shuffledQuestions = shuffle([...allQuestions]);
  const shuffledFacts = shuffle([...infoFacts]);

  let qIdx = 0;
  let fIdx = 0;

  for (let i = 0; i < routeOrder.length; i++) {
    const name = routeOrder[i];
    const isArtifact = (i === ARTIFACT_INDEX);
    const isStart = (i === 0);
    const isEnd = (i === routeOrder.length - 1);

    if (isStart || isEnd) {
      towns.push({
        name,
        type: isStart ? "start" : "end",
        isArtifact: false
      });
    } else if (questionIndices.has(i)) {
      const q = shuffledQuestions[qIdx++];
      towns.push({
        name,
        type: "question",
        question: q.question,
        choices: q.choices,
        answerIndex: q.answerIndex,
        fact: q.fact,
        isArtifact
      });
    } else {
      const f = shuffledFacts[fIdx++];
      towns.push({
        name,
        type: "fact",
        fact: f,
        isArtifact
      });
    }
  }

  return towns;
}

// State management
const STORAGE_KEY = "indiana_treasure_quest_v3";
const LEADERBOARD_KEY = "indiana_treasure_quest_leaderboard";

// Leaderboard functions
function loadLeaderboard() {
  try {
    const saved = JSON.parse(localStorage.getItem(LEADERBOARD_KEY));
    return Array.isArray(saved) ? saved : [];
  } catch (e) {
    return [];
  }
}

// Teacher and School options
const TEACHERS = ["Roberts", "Reep", "Dolphin"];
const SCHOOLS = ["Springhill", "Lafayette", "Burton", "Happy Valley"];

function saveToLeaderboard(name, teacher, school, score, coins) {
  const leaderboard = loadLeaderboard();
  const entry = {
    name: name.trim(),
    teacher: teacher,
    school: school,
    // Keep className for backward compatibility (teacher + school)
    className: `${teacher} - ${school}`,
    score: score,
    coins: coins,
    totalPoints: score * 10 + coins,
    date: new Date().toLocaleDateString()
  };
  leaderboard.push(entry);
  leaderboard.sort((a, b) => b.totalPoints - a.totalPoints);
  const top50 = leaderboard.slice(0, 50); // Keep more for rankings
  localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(top50));
  return top50;
}

function getClassRankings(leaderboard) {
  // Group by teacher and calculate total points per class
  const classStats = {};
  leaderboard.forEach(entry => {
    const teacher = entry.teacher || "Unknown";
    if (!classStats[teacher]) {
      classStats[teacher] = { teacher, totalPoints: 0, count: 0, avgPoints: 0 };
    }
    classStats[teacher].totalPoints += entry.totalPoints;
    classStats[teacher].count += 1;
  });
  // Calculate average and sort by total points
  Object.values(classStats).forEach(stat => {
    stat.avgPoints = Math.round(stat.totalPoints / stat.count);
  });
  return Object.values(classStats).sort((a, b) => b.totalPoints - a.totalPoints);
}

function getSchoolRankings(leaderboard) {
  // Group by school and calculate total points per school
  const schoolStats = {};
  leaderboard.forEach(entry => {
    const school = entry.school || "Unknown";
    if (!schoolStats[school]) {
      schoolStats[school] = { school, totalPoints: 0, count: 0, avgPoints: 0 };
    }
    schoolStats[school].totalPoints += entry.totalPoints;
    schoolStats[school].count += 1;
  });
  // Calculate average and sort by total points
  Object.values(schoolStats).forEach(stat => {
    stat.avgPoints = Math.round(stat.totalPoints / stat.count);
  });
  return Object.values(schoolStats).sort((a, b) => b.totalPoints - a.totalPoints);
}

function renderIndividualLeaderboard(leaderboard) {
  if (leaderboard.length === 0) {
    return '<p style="text-align: center; color: #888;">No scores yet. Be the first!</p>';
  }
  return leaderboard.slice(0, 10).map((entry, i) => `
    <div class="leaderboard-entry">
      <span class="leaderboard-rank">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.'}</span>
      <span class="leaderboard-name">${entry.name}</span>
      <span class="leaderboard-class">${entry.teacher || entry.className || 'N/A'}</span>
      <span class="leaderboard-score">${entry.totalPoints} pts</span>
    </div>
  `).join('');
}

function renderClassLeaderboard(leaderboard) {
  const classRankings = getClassRankings(leaderboard);
  if (classRankings.length === 0) {
    return '<p style="text-align: center; color: #888;">No class scores yet!</p>';
  }
  return classRankings.map((stat, i) => `
    <div class="leaderboard-entry">
      <span class="leaderboard-rank">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.'}</span>
      <span class="leaderboard-name">üë©‚Äçüè´ ${stat.teacher}</span>
      <span class="leaderboard-class">${stat.count} player${stat.count !== 1 ? 's' : ''}</span>
      <span class="leaderboard-score">${stat.totalPoints} pts</span>
    </div>
  `).join('') + `
    <p style="text-align: center; font-size: 11px; color: #888; margin-top: 8px;">Total points from all players in each class</p>
  `;
}

function renderSchoolLeaderboard(leaderboard) {
  const schoolRankings = getSchoolRankings(leaderboard);
  if (schoolRankings.length === 0) {
    return '<p style="text-align: center; color: #888;">No school scores yet!</p>';
  }
  return schoolRankings.map((stat, i) => `
    <div class="leaderboard-entry">
      <span class="leaderboard-rank">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i + 1) + '.'}</span>
      <span class="leaderboard-name">üè´ ${stat.school}</span>
      <span class="leaderboard-class">${stat.count} player${stat.count !== 1 ? 's' : ''}</span>
      <span class="leaderboard-score">${stat.totalPoints} pts</span>
    </div>
  `).join('') + `
    <p style="text-align: center; font-size: 11px; color: #888; margin-top: 8px;">Total points from all players at each school</p>
  `;
}

function loadState() {
  try {
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (saved && saved.towns) return saved;
    return null;
  } catch { return null; }
}

let gameData = loadState();
if (!gameData) {
  gameData = {
    stage: "avatar",
    avatar: null,
    idx: 0,
    score: 0,
    coins: 0,
    hasArtifact: false,
    review: "",
    towns: buildTownsArray()
  };
}

const state = gameData;
let gameMap = null;
let markers = {};
let avatarMarker = null;
let routeLine = null;
let traveledLine = null;

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

const appEl = document.getElementById("app");
const statusPill = document.getElementById("statusPill");
const scorePill = document.getElementById("scorePill");
const progressBar = document.getElementById("progressBar");

document.getElementById("resetBtn").onclick = () => {
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
};

function setTopUI() {
  const coinsDisplay = state.coins > 0 ? ` | ü™ô ${state.coins}` : '';
  scorePill.textContent = `Score: ${state.score}/26${coinsDisplay}`;
  const totalStops = state.towns.length - 1;
  const pct = Math.round((state.idx / totalStops) * 100);
  progressBar.style.width = `${Math.min(100, pct)}%`;

  let status = "Not started";
  if (state.stage === "avatar") status = "Choose Avatar";
  else if (state.stage === "story") status = "Your Mission";
  else if (state.stage === "map") status = `${state.towns[state.idx]?.name || "Traveling"}`;
  else if (state.stage === "sewer") status = "In the Sewers";
  else if (state.stage === "tunnel") status = "In the Tunnel";
  else if (state.stage === "question" || state.stage === "fact") status = state.towns[state.idx]?.name;
  else if (state.stage === "artifact") status = "‚≠ê Artifact Found!";
  else if (state.stage === "end") status = "Mission Complete!";

  if (state.hasArtifact && state.stage !== "end" && state.stage !== "artifact") {
    status += " üìú";
  }

  statusPill.textContent = status;
}

function render() {
  setTopUI();
  // Clean up any previous Enter key listener
  if (window.currentEnterHandler) {
    document.removeEventListener('keydown', window.currentEnterHandler);
    window.currentEnterHandler = null;
  }
  // Clean up avatar arrow key handler
  if (window.currentAvatarKeyHandler) {
    document.removeEventListener('keydown', window.currentAvatarKeyHandler);
    window.currentAvatarKeyHandler = null;
  }

  if (state.stage === "avatar") return renderAvatar();
  if (state.stage === "story") return renderStory();
  if (state.stage === "map") return renderMap();
  if (state.stage === "sewer") return renderSewer();
  if (state.stage === "tunnel") return renderTunnel();
  if (state.stage === "question") return renderQuestion();
  if (state.stage === "fact") return renderFact();
  if (state.stage === "artifact") return renderArtifact();
  if (state.stage === "end") return renderEnd();
}

// Helper to add Enter key support for a button
function addEnterKeySupport(buttonId) {
  const handler = (e) => {
    if (e.key === 'Enter') {
      const btn = document.getElementById(buttonId);
      if (btn && !btn.disabled) {
        e.preventDefault();
        btn.click();
      }
    }
  };
  window.currentEnterHandler = handler;
  document.addEventListener('keydown', handler);
}

// Famous Hoosiers data with sprite paths and GIFs
// hasWalkAnim indicates if the sprite has frame-by-frame walking animations
const famousHoosiers = [
  { id: "mj", name: "Michael Jackson", title: "King of Pop", emoji: "üé§", portrait: "portrait-mj", hometown: "Gary", sprite: "sprites/michael_jackson", gif: "sprites/michael_jackson/Michael_Jackson_rotations_8dir.gif", hasWalkAnim: true },
  { id: "larry", name: "Larry Bird", title: "NBA Legend", emoji: "üèÄ", portrait: "portrait-larry", hometown: "French Lick", sprite: "sprites/larry_bird", gif: "sprites/larry_bird/Larry_Bird_rotations_8dir.gif", hasWalkAnim: true },
  { id: "james", name: "James Dean", title: "Hollywood Icon", emoji: "üé¨", portrait: "portrait-james", hometown: "Marion", sprite: "sprites/james_dean", gif: "sprites/james_dean/James_Dean_rotations_8dir.gif", hasWalkAnim: true },
  { id: "abe", name: "Abraham Lincoln", title: "16th President", emoji: "üé©", portrait: "portrait-abe", hometown: "Spencer County", sprite: "sprites/Abraham_Lincoln", gif: "sprites/Abraham_Lincoln/Abraham_Lincoln_rotations_8dir.gif", hasWalkAnim: true },
  { id: "axl", name: "Axl Rose", title: "Rock Legend", emoji: "üé∏", portrait: "portrait-axl", hometown: "Lafayette", sprite: "sprites/Axl_Rose", gif: "sprites/Axl_Rose/Axl_Rose_rotations_8dir.gif", hasWalkAnim: true },
  { id: "david", name: "David Letterman", title: "TV Host", emoji: "üì∫", portrait: "portrait-david", hometown: "Indianapolis", sprite: "sprites/David_Letterman", gif: "sprites/David_Letterman/David_Letterman_rotations_8dir.gif", hasWalkAnim: true },
  { id: "john", name: "John Mellencamp", title: "Rock Singer", emoji: "üéµ", portrait: "portrait-john", hometown: "Seymour", sprite: "sprites/John_Mellencamp_in_jeans_and_t-shirt_rocker_style", gif: "sprites/John_Mellencamp_in_jeans_and_t-shirt_rocker_style/John_Mellencamp_in_jeans_and_t-shirt_rocker_style_rotations_8dir.gif", hasWalkAnim: true },
  { id: "orville", name: "Orville Redenbacher", title: "Popcorn King", emoji: "üçø", portrait: "portrait-orville", hometown: "Brazil", sprite: "sprites/Orville_Redenbacher_Orville_Redenbacher_in_suit_wi", gif: "sprites/Orville_Redenbacher_Orville_Redenbacher_in_suit_wi/Orville_Redenbacher_Orville_Redenbacher_in_suit_wi_rotations_8dir.gif", hasWalkAnim: true }
];

// Helper to get sprite image HTML
function getSpriteImg(hoosier, size = 64, direction = "south") {
  if (hoosier.sprite) {
    return `<img src="${hoosier.sprite}/rotations/${direction}.png" class="sprite-img" style="width:${size}px;height:${size}px;" alt="${hoosier.name}">`;
  }
  return `<span style="font-size:${size * 0.6}px">${hoosier.emoji}</span>`;
}

// Helper to get current hoosier data
function getCurrentHoosier() {
  return famousHoosiers.find(h => h.id === state.avatarId) || famousHoosiers[0];
}

// Sprite animation system
let spriteAnimationInterval = null;
let currentAnimationFrame = 0;

function startSpriteAnimation(elementId, hoosier, animation = "walking", direction = "south", frameCount = 6, fps = 8) {
  stopSpriteAnimation();
  if (!hoosier.sprite) return;

  const el = document.getElementById(elementId);
  if (!el) return;

  currentAnimationFrame = 0;
  spriteAnimationInterval = setInterval(() => {
    const framePath = `${hoosier.sprite}/animations/${animation}/${direction}/frame_00${currentAnimationFrame}.png`;
    el.src = framePath;
    currentAnimationFrame = (currentAnimationFrame + 1) % frameCount;
  }, 1000 / fps);
}

function stopSpriteAnimation() {
  if (spriteAnimationInterval) {
    clearInterval(spriteAnimationInterval);
    spriteAnimationInterval = null;
  }
}

// Get sprite direction based on movement vector
function getDirectionForMovement(fromCoords, toCoords) {
  const dx = toCoords.lng - fromCoords.lng;
  const dy = toCoords.lat - fromCoords.lat;
  const angle = Math.atan2(dy, dx) * (180 / Math.PI);

  // Convert angle to 8-direction
  if (angle >= -22.5 && angle < 22.5) return "east";
  if (angle >= 22.5 && angle < 67.5) return "north-east";
  if (angle >= 67.5 && angle < 112.5) return "north";
  if (angle >= 112.5 && angle < 157.5) return "north-west";
  if (angle >= 157.5 || angle < -157.5) return "west";
  if (angle >= -157.5 && angle < -112.5) return "south-west";
  if (angle >= -112.5 && angle < -67.5) return "south";
  if (angle >= -67.5 && angle < -22.5) return "south-east";
  return "south";
}

function renderAvatar() {
  // Play intro music
  AudioSystem.playMusic('intro');

  const leaderboard = loadLeaderboard();

  appEl.innerHTML = `
    <h1 class="intro-title">üó∫Ô∏è Indiana Treasure Quest</h1>
    <p class="intro-subtitle">An Epic Adventure Through the Hoosier State!</p>
    <p style="text-align: center; margin-bottom: 16px;">Choose a famous Hoosier to guide your adventure:</p>
    <div class="avatar-grid" id="avatars"></div>
    <div style="height:16px"></div>
    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
      <button class="btn" id="startBtn" disabled>üöÄ Begin Adventure</button>
      <button class="btn secondary" id="viewLeaderboardBtn">üèÜ Leaderboard</button>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; padding: 20px; overflow-y: auto;">
      <div style="max-width: 500px; margin: 0 auto; background: linear-gradient(180deg, #1a2744 0%, #0f1730 100%); border-radius: 16px; padding: 20px; border: 1px solid #2a3b73;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">üèÜ Leaderboard</h2>
          <button class="btn secondary" id="closeLeaderboardBtn" style="padding: 8px 16px;">‚úï Close</button>
        </div>

        <!-- Leaderboard Tabs -->
        <div style="display: flex; gap: 4px; margin-bottom: 12px; justify-content: center;">
          <button class="btn small" id="modalTabIndividual" style="padding: 6px 12px; font-size: 12px;">ü•á Players</button>
          <button class="btn small secondary" id="modalTabClass" style="padding: 6px 12px; font-size: 12px;">üë©‚Äçüè´ Classes</button>
          <button class="btn small secondary" id="modalTabSchool" style="padding: 6px 12px; font-size: 12px;">üè´ Schools</button>
        </div>

        <div id="modalLeaderboardList">
          ${renderIndividualLeaderboard(leaderboard)}
        </div>
      </div>
    </div>
  `;

  // Narrate the intro
  setTimeout(() => {
    AudioSystem.speak("Welcome to Indiana Treasure Quest! Choose a famous Hoosier to guide your adventure through the great state of Indiana.", { rate: 0.9 });
  }, 500);

  const avatarsEl = document.getElementById("avatars");
  const cards = [];
  let focusedIndex = state.avatarId ? famousHoosiers.findIndex(h => h.id === state.avatarId) : 0;
  if (focusedIndex < 0) focusedIndex = 0;

  famousHoosiers.forEach((hoosier, idx) => {
    const isSelected = state.avatar === hoosier.emoji && state.avatarId === hoosier.id;
    const card = document.createElement("div");
    card.className = "hoosier-card" + (isSelected ? " selected" : "");
    card.setAttribute("tabindex", "0");
    card.dataset.index = idx;
    // Use animated GIF if available, otherwise static sprite
    const avatarImg = hoosier.gif
      ? `<img src="${hoosier.gif}" class="sprite-img" style="width:64px;height:64px;" alt="${hoosier.name}">`
      : getSpriteImg(hoosier, 64, "south");
    card.innerHTML = `
      <div class="hoosier-portrait ${hoosier.portrait}">
        ${avatarImg}
      </div>
      <div class="name">${hoosier.name}</div>
      <div class="title">${hoosier.title}</div>
    `;
    card.onclick = () => selectAvatar(idx);
    cards.push(card);
    avatarsEl.appendChild(card);
  });

  function selectAvatar(idx) {
    const hoosier = famousHoosiers[idx];
    AudioSystem.playSound('click');
    state.avatar = hoosier.emoji;
    state.avatarId = hoosier.id;
    state.avatarName = hoosier.name;
    saveState();
    render();
    // Announce selection
    AudioSystem.speak(`You selected ${hoosier.name}, the ${hoosier.title} from ${hoosier.hometown}.`, { rate: 1.0 });
  }

  function updateFocus(newIndex) {
    // Remove focus from all cards
    cards.forEach(c => c.classList.remove("focused"));
    focusedIndex = newIndex;
    cards[focusedIndex].classList.add("focused");
    cards[focusedIndex].focus();
  }

  // Set initial focus
  setTimeout(() => updateFocus(focusedIndex), 100);

  // Arrow key navigation (4 columns in the grid)
  const cols = 4;
  const avatarKeyHandler = (e) => {
    const key = e.key;
    let newIndex = focusedIndex;

    if (key === "ArrowRight") {
      newIndex = (focusedIndex + 1) % famousHoosiers.length;
      e.preventDefault();
    } else if (key === "ArrowLeft") {
      newIndex = (focusedIndex - 1 + famousHoosiers.length) % famousHoosiers.length;
      e.preventDefault();
    } else if (key === "ArrowDown") {
      newIndex = (focusedIndex + cols) % famousHoosiers.length;
      e.preventDefault();
    } else if (key === "ArrowUp") {
      newIndex = (focusedIndex - cols + famousHoosiers.length) % famousHoosiers.length;
      e.preventDefault();
    } else if (key === " " || key === "Spacebar") {
      // Space selects the focused avatar
      e.preventDefault();
      selectAvatar(focusedIndex);
      return;
    }

    if (newIndex !== focusedIndex) {
      updateFocus(newIndex);
    }
  };
  document.addEventListener('keydown', avatarKeyHandler);
  window.currentAvatarKeyHandler = avatarKeyHandler;

  const startBtn = document.getElementById("startBtn");
  startBtn.disabled = !state.avatar;
  startBtn.onclick = () => {
    AudioSystem.playSound('click');
    AudioSystem.stopSpeaking();
    state.stage = "story";
    saveState();
    render();
  };

  // Leaderboard modal handlers
  let modalTab = 'individual';
  const modal = document.getElementById("leaderboardModal");
  const modalList = document.getElementById("modalLeaderboardList");

  function updateModalTabStyles() {
    document.getElementById('modalTabIndividual').className = modalTab === 'individual' ? 'btn small' : 'btn small secondary';
    document.getElementById('modalTabClass').className = modalTab === 'class' ? 'btn small' : 'btn small secondary';
    document.getElementById('modalTabSchool').className = modalTab === 'school' ? 'btn small' : 'btn small secondary';
  }

  function refreshModalDisplay() {
    if (modalTab === 'individual') {
      modalList.innerHTML = renderIndividualLeaderboard(leaderboard);
    } else if (modalTab === 'class') {
      modalList.innerHTML = renderClassLeaderboard(leaderboard);
    } else {
      modalList.innerHTML = renderSchoolLeaderboard(leaderboard);
    }
  }

  document.getElementById("viewLeaderboardBtn").onclick = () => {
    AudioSystem.playSound('click');
    modal.style.display = "block";
  };

  document.getElementById("closeLeaderboardBtn").onclick = () => {
    AudioSystem.playSound('click');
    modal.style.display = "none";
  };

  document.getElementById('modalTabIndividual').onclick = () => {
    AudioSystem.playSound('click');
    modalTab = 'individual';
    updateModalTabStyles();
    refreshModalDisplay();
  };

  document.getElementById('modalTabClass').onclick = () => {
    AudioSystem.playSound('click');
    modalTab = 'class';
    updateModalTabStyles();
    refreshModalDisplay();
  };

  document.getElementById('modalTabSchool').onclick = () => {
    AudioSystem.playSound('click');
    modalTab = 'school';
    updateModalTabStyles();
    refreshModalDisplay();
  };

  // Close modal on escape key
  const modalEscHandler = (e) => {
    if (e.key === 'Escape' && modal.style.display === 'block') {
      AudioSystem.playSound('click');
      modal.style.display = 'none';
    }
  };
  document.addEventListener('keydown', modalEscHandler);

  // Enter key support
  addEnterKeySupport("startBtn");
}

function renderStory() {
  const displayName = state.avatarName || "Agent";
  const hoosier = getCurrentHoosier();

  // Play adventure music
  AudioSystem.playMusic('adventure');

  appEl.innerHTML = `
    <h2>üîí Top Secret Mission</h2>
    <div style="display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 16px 0; padding: 16px; background: linear-gradient(135deg, #1a2744 0%, #0f1730 100%); border-radius: 12px;">
      <div style="text-align: center;">
        <div style="font-size: 64px; margin-bottom: 4px;">üë®‚Äçüíº</div>
        <small style="opacity: 0.7;">Mayor Joe Hogsett</small>
      </div>
      <div style="font-size: 28px; margin-bottom: 30px;">üí¨</div>
      <div style="text-align: center;">
        ${getSpriteImg(hoosier, 72, "south")}
        <small style="opacity: 0.7; display: block; margin-top: 4px;">${displayName}</small>
      </div>
    </div>
    <div style="background: rgba(43,99,255,.1); border-left: 4px solid #2b63ff; padding: 12px 16px; border-radius: 0 8px 8px 0; margin-bottom: 12px;">
      <p style="margin: 0; font-style: italic;">
        "<b>${displayName},</b> I have a critical mission for you. A precious <b>astrolabe</b>‚Äîa navigation instrument carried by a chief during the tragic 'Trail of Death' removal march of 1838‚Äîhas been lost somewhere in Indiana."
      </p>
    </div>
    <p>
      You must travel through an underground sewer system, visiting towns across the state and
      answering questions about Indiana's history and culture. Find the artifact and return it
      to Indianapolis!
    </p>
    <div class="row">
      <button class="btn" id="beginBtn">üöá Enter the Sewers</button>
    </div>
    <div style="height:10px"></div>
    <small>üíæ Your progress is saved automatically.</small>
  `;

  // Narrate the mission briefing
  setTimeout(() => {
    AudioSystem.speak(
      `${displayName}, the Mayor of Indianapolis has assigned you a critical mission. ` +
      `A precious astrolabe, a navigation instrument carried by a chief during the tragic Trail of Death removal march of 1838, has been lost somewhere in Indiana. ` +
      `You must travel through an underground sewer system, visiting towns across the state. Find the artifact and return it to Indianapolis!`,
      { rate: 0.9 }
    );
  }, 300);

  document.getElementById("beginBtn").onclick = () => {
    AudioSystem.playSound('click');
    AudioSystem.stopSpeaking();
    state.idx = 1;
    state.stage = "map";
    saveState();
    render();
  };

  // Enter key support
  addEnterKeySupport("beginBtn");
}

function initMap() {
  // Center on Indiana
  const indianaCenter = [39.8, -86.2];

  gameMap = L.map('gameMap', {
    zoomControl: true,
    scrollWheelZoom: true
  }).setView(indianaCenter, 7);

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(gameMap);

  // Build route coordinates
  const routeCoords = routeOrder.map(name => {
    const c = townCoords[name];
    return [c.lat, c.lng];
  });

  // Draw full route (dashed, lighter)
  routeLine = L.polyline(routeCoords, {
    color: '#64748b',
    weight: 3,
    opacity: 0.5,
    dashArray: '10, 10'
  }).addTo(gameMap);

  // Draw traveled route (solid, green)
  updateTraveledLine();

  // Add markers for each town
  for (const [name, coords] of Object.entries(townCoords)) {
    const routeIdx = routeOrder.indexOf(name);
    const isVisited = routeIdx !== -1 && routeIdx < state.idx;
    const isCurrent = routeIdx === state.idx;
    const isArtifactTown = routeIdx === ARTIFACT_INDEX;
    const isStart = name === "Indianapolis" && routeIdx === 0;

    let markerClass = "marker-dot";
    if (isStart) markerClass += " start";
    else if (isCurrent) markerClass += " current";
    else if (isVisited) markerClass += " visited";
    else markerClass += " unvisited";

    if (isArtifactTown && state.hasArtifact) markerClass += " artifact";

    const icon = L.divIcon({
      className: 'custom-marker',
      html: `<div class="${markerClass}"></div>`,
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    const marker = L.marker([coords.lat, coords.lng], { icon })
      .addTo(gameMap)
      .bindTooltip(name, {
        permanent: false,
        direction: 'top',
        offset: [0, -10]
      });

    markers[name] = marker;
  }

  // Add avatar marker - start at previous position for animation
  const currentTown = state.towns[state.idx];
  const currentCoords = townCoords[currentTown.name];

  // Get previous town for animation start point
  const prevIdx = Math.max(0, state.idx - 1);
  const prevTown = routeOrder[prevIdx];
  const prevCoords = townCoords[prevTown];

  // Get direction based on movement
  const hoosier = getCurrentHoosier();
  const direction = getDirectionForMovement(prevCoords, currentCoords);

  const avatarIcon = L.divIcon({
    className: 'custom-marker',
    html: `<img id="mapAvatarSprite" src="${hoosier.sprite}/rotations/${direction}.png" class="avatar-sprite" style="width:48px;height:48px;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.5));" alt="${hoosier.name}">`,
    iconSize: [48, 48],
    iconAnchor: [24, 24]
  });

  // Start avatar at previous position
  avatarMarker = L.marker([prevCoords.lat, prevCoords.lng], {
    icon: avatarIcon,
    zIndexOffset: 1000
  }).addTo(gameMap);

  // Fit map to show both points
  const bounds = L.latLngBounds([
    [prevCoords.lat, prevCoords.lng],
    [currentCoords.lat, currentCoords.lng]
  ]);
  gameMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 9 });
}

// Animate avatar movement along the route
function animateAvatarMovement(callback) {
  const currentTown = state.towns[state.idx];
  const currentCoords = townCoords[currentTown.name];
  const prevIdx = Math.max(0, state.idx - 1);
  const prevTown = routeOrder[prevIdx];
  const prevCoords = townCoords[prevTown];

  if (!avatarMarker || prevIdx === state.idx) {
    if (callback) callback();
    return;
  }

  const startLat = prevCoords.lat;
  const startLng = prevCoords.lng;
  const endLat = currentCoords.lat;
  const endLng = currentCoords.lng;

  // Get direction and start walking animation
  const hoosier = getCurrentHoosier();
  const direction = getDirectionForMovement(prevCoords, currentCoords);

  // Start walking animation on map sprite
  let mapAnimFrame = 0;
  let mapAnimInterval = null;

  const spriteEl = document.getElementById("mapAvatarSprite");
  if (spriteEl) {
    if (hoosier.hasWalkAnim) {
      // Use frame-by-frame animation (try direction, fallback to south)
      const walkDir = direction;
      mapAnimInterval = setInterval(() => {
        const frameSrc = `${hoosier.sprite}/animations/walking/${walkDir}/frame_00${mapAnimFrame}.png`;
        spriteEl.onerror = () => {
          // Try south direction as fallback
          spriteEl.src = `${hoosier.sprite}/animations/walking/south/frame_00${mapAnimFrame}.png`;
        };
        spriteEl.src = frameSrc;
        mapAnimFrame = (mapAnimFrame + 1) % 6;
      }, 125);
    } else if (hoosier.gif) {
      // Use rotating GIF for characters without frame animations
      spriteEl.src = hoosier.gif;
    }
  }

  const duration = 1500; // 1.5 seconds
  const startTime = performance.now();

  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);

    // Easing function for smooth movement
    const easeProgress = 1 - Math.pow(1 - progress, 3);

    const lat = startLat + (endLat - startLat) * easeProgress;
    const lng = startLng + (endLng - startLng) * easeProgress;

    avatarMarker.setLatLng([lat, lng]);

    // Pan map to follow avatar
    if (gameMap) {
      gameMap.panTo([lat, lng], { animate: false });
    }

    if (progress < 1) {
      requestAnimationFrame(animate);
    } else {
      // Animation complete - stop walking animation and show standing sprite
      if (mapAnimInterval) {
        clearInterval(mapAnimInterval);
      }
      const spriteEl = document.getElementById("mapAvatarSprite");
      if (spriteEl && hoosier.sprite) {
        spriteEl.src = `${hoosier.sprite}/rotations/${direction}.png`;
      }
      updateTraveledLine();
      if (callback) callback();
    }
  }

  requestAnimationFrame(animate);
}

function updateTraveledLine() {
  if (traveledLine) {
    gameMap.removeLayer(traveledLine);
  }

  if (state.idx > 0) {
    const traveledCoords = [];
    for (let i = 0; i <= state.idx && i < routeOrder.length; i++) {
      const c = townCoords[routeOrder[i]];
      traveledCoords.push([c.lat, c.lng]);
    }

    traveledLine = L.polyline(traveledCoords, {
      color: '#1fd18b',
      weight: 4,
      opacity: 0.8
    }).addTo(gameMap);
  }
}

function updateMarkers() {
  for (const [name, marker] of Object.entries(markers)) {
    const routeIdx = routeOrder.indexOf(name);
    const isVisited = routeIdx !== -1 && routeIdx < state.idx;
    const isCurrent = routeIdx === state.idx;
    const isArtifactTown = routeIdx === ARTIFACT_INDEX;
    const isStart = name === "Indianapolis" && routeIdx === 0;

    let markerClass = "marker-dot";
    if (isStart && !isCurrent) markerClass += " start";
    else if (isCurrent) markerClass += " current";
    else if (isVisited) markerClass += " visited";
    else markerClass += " unvisited";

    if (isArtifactTown && state.hasArtifact) markerClass += " artifact";

    const icon = L.divIcon({
      className: 'custom-marker',
      html: `<div class="${markerClass}"></div>`,
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    marker.setIcon(icon);
  }

  // Update avatar position
  const currentTown = state.towns[state.idx];
  const currentCoords = townCoords[currentTown.name];

  if (avatarMarker) {
    avatarMarker.setLatLng([currentCoords.lat, currentCoords.lng]);
  }

  updateTraveledLine();
}

function renderMap() {
  const currentTown = state.towns[state.idx];
  const prevIdx = Math.max(0, state.idx - 1);
  const prevTown = routeOrder[prevIdx];

  // Play walking music
  AudioSystem.playMusic('walking');

  appEl.innerHTML = `
    <h2>üó∫Ô∏è Traveling to ${currentTown.name}</h2>
    <p style="text-align: center; opacity: 0.8; margin: 0 0 12px;">From ${prevTown} ‚Üí ${currentTown.name}</p>
    <div class="map-container">
      <div id="gameMap"></div>
    </div>
    <div class="row" style="justify-content: center;">
      <button class="btn" id="arriveBtn" disabled>üö∂ Traveling...</button>
    </div>
  `;

  const arriveBtn = document.getElementById("arriveBtn");

  // Initialize map after DOM is ready
  setTimeout(() => {
    if (gameMap) {
      gameMap.remove();
      gameMap = null;
    }
    initMap();

    // Start the animation after map loads
    setTimeout(() => {
      animateAvatarMovement(() => {
        // Enable button after animation completes
        AudioSystem.stopMusic();
        arriveBtn.disabled = false;
        arriveBtn.textContent = `üìç Arrive at ${currentTown.name}`;
        AudioSystem.speak(`You have arrived at ${currentTown.name}.`, { rate: 1.0 });
      });
    }, 500);
  }, 100);

  arriveBtn.onclick = () => {
    AudioSystem.playSound('click');
    AudioSystem.stopSpeaking();
    const town = state.towns[state.idx];

    if (town.type === "end") {
      state.stage = "end";  // Final destination - no sewer needed
    } else {
      state.stage = "sewer";  // Enter sewer to reach the town
    }

    saveState();
    render();
  };

  // Enter key support
  addEnterKeySupport("arriveBtn");
}

function renderSewer() {
  const currentTown = state.towns[state.idx];
  const hoosier = getCurrentHoosier();

  // Play sewer ambience
  AudioSystem.playMusic('sewer');

  // Use GIF for walking if no frame animations available, otherwise use static as starting point
  const sewerImgSrc = hoosier.hasWalkAnim
    ? `${hoosier.sprite}/rotations/south.png`
    : (hoosier.gif || `${hoosier.sprite}/rotations/south.png`);

  appEl.innerHTML = `
    <div class="sewer-scene">
      <!-- Visual sewer tunnel background -->
      <div class="sewer-tunnel"></div>

      <!-- Circular sewer pipe opening -->
      <div class="sewer-pipe"></div>

      <!-- Character entering the pipe -->
      <div class="sewer-sprite-container">
        <img id="sewerSprite" src="${sewerImgSrc}" class="sprite-img" style="width:72px;height:72px;" alt="${hoosier.name}">
      </div>

      <!-- Dripping water effects -->
      <div class="sewer-drip"></div>
      <div class="sewer-drip"></div>
      <div class="sewer-drip"></div>
      <div class="sewer-drip"></div>

      <!-- Flowing water at bottom -->
      <div class="sewer-water"></div>

      <!-- Text content -->
      <div class="sewer-content">
        <h2 style="color: #8a8a8a; text-shadow: 2px 2px 4px #000;">üöá Underground Sewers</h2>
        <p style="color: #6a6a6a;">Navigating the dark tunnels beneath Indiana...</p>
        <p style="color: #9a9a9a;">Approaching: <b style="color: #c9a227;">${currentTown.name}</b></p>
      </div>
    </div>
  `;

  // Narrate the sewer transition
  setTimeout(() => {
    AudioSystem.speak(`Traveling through the sewers... Approaching ${currentTown.name}.`, { rate: 1.0 });
  }, 300);

  // Start walking animation in sewer (only if has frame animations)
  if (hoosier.hasWalkAnim) {
    startSpriteAnimation("sewerSprite", hoosier, "walking", "south", 6, 8);
  }

  // Auto-transition to tunnel game after brief sewer scene
  setTimeout(() => {
    AudioSystem.stopSpeaking();
    stopSpriteAnimation();
    state.stage = "tunnel";
    saveState();
    render();
  }, 2500);
}

// Random NPCs that can appear in the tunnel
const tunnelNPCs = [
  { emoji: "üë∑", name: "Sewer Worker" },
  { emoji: "üßë‚Äçüî¨", name: "Scientist" },
  { emoji: "üë®‚Äçüè´", name: "Teacher" },
  { emoji: "üë©‚Äçüåæ", name: "Farmer" },
  { emoji: "üßô", name: "Old Timer" },
  { emoji: "üë®‚Äçüç≥", name: "Chef" },
  { emoji: "üïµÔ∏è", name: "Detective" },
  { emoji: "üë®‚Äçüöí", name: "Firefighter" }
];

let tunnelGameActive = false;
let tunnelAnimationFrame = null;

function renderTunnel() {
  const currentTown = state.towns[state.idx];
  const hoosier = getCurrentHoosier();
  const npc = tunnelNPCs[Math.floor(Math.random() * tunnelNPCs.length)];

  // Play adventure music
  AudioSystem.playMusic('adventure');

  appEl.innerHTML = `
    <h2 style="text-align: center; margin-bottom: 12px;">üöá Underground Tunnel to ${currentTown.name}</h2>
    <div class="tunnel-game" id="tunnelGame">
      <div class="tunnel-game-bg"></div>
      <div class="tunnel-floor"></div>
      <div class="tunnel-water"></div>
      <div class="tunnel-hud">
        <div class="tunnel-coins-display">ü™ô <span id="tunnelCoins">0</span></div>
        <div class="tunnel-instructions">‚Üê ‚Üí to move, collect coins!</div>
      </div>
      <div class="tunnel-player" id="tunnelPlayer" style="left: 5%;">
        <img id="tunnelPlayerImg" src="${hoosier.sprite}/rotations/east.png" alt="${hoosier.name}">
      </div>
      <div class="tunnel-npc" id="tunnelNpc">
        <img src="${npc.sprite || ''}" alt="${npc.name}" onerror="this.parentElement.textContent='${npc.emoji}'">
      </div>
      <div class="tunnel-speech" id="tunnelSpeech">Hey there! Come talk to me!</div>
      <div id="tunnelCoinsContainer"></div>
    </div>
    <p id="tunnelMessage" style="text-align: center; margin-top: 12px; opacity: 0.8;">Navigate through the tunnel and collect coins!</p>
  `;

  // Initialize tunnel game
  initTunnelGame(hoosier, npc, currentTown);
}

function initTunnelGame(hoosier, npc, currentTown) {
  const gameEl = document.getElementById('tunnelGame');
  const playerEl = document.getElementById('tunnelPlayer');
  const playerImg = document.getElementById('tunnelPlayerImg');
  const coinsContainer = document.getElementById('tunnelCoinsContainer');
  const coinsDisplay = document.getElementById('tunnelCoins');
  const speechEl = document.getElementById('tunnelSpeech');
  const messageEl = document.getElementById('tunnelMessage');

  // Use percentages for responsive positioning
  let playerXPercent = 5;  // Start at 5% from left
  let playerY = 0;  // Jump height in pixels (relative to base)
  let jumpVelocity = 0;
  let isJumping = false;
  const gravity = 0.8;
  const jumpStrength = 14;
  let coinsCollected = 0;
  const npcXPercent = 85;  // NPC at 85% from left

  tunnelGameActive = true;

  // Spawn coins at different heights using percentages
  const coins = [];
  const numCoins = 6 + Math.floor(Math.random() * 4); // 6-9 coins

  for (let i = 0; i < numCoins; i++) {
    // Coin X position: 15% to 75% of game width
    const coinXPercent = 15 + Math.random() * 60;
    // Coin Y: low coins at 75-85px, high coins at 130-180px from bottom
    const isHighCoin = Math.random() > 0.5;
    const coinYPx = isHighCoin ? 130 + Math.random() * 50 : 75 + Math.random() * 15;
    const coinEl = document.createElement('div');
    coinEl.className = 'tunnel-coin';
    coinEl.textContent = 'ü™ô';
    coinEl.style.left = `${coinXPercent}%`;
    coinEl.style.bottom = `${coinYPx}px`;
    coinsContainer.appendChild(coinEl);
    coins.push({ el: coinEl, xPercent: coinXPercent, yPx: coinYPx, collected: false });
  }

  // Walking animation frame
  let walkFrame = 0;
  let walkInterval = null;

  function startWalking(direction) {
    if (walkInterval) return;
    walkInterval = setInterval(() => {
      if (hoosier.hasWalkAnim) {
        playerImg.src = `${hoosier.sprite}/animations/walking/${direction}/frame_00${walkFrame}.png`;
        playerImg.onerror = () => {
          playerImg.src = `${hoosier.sprite}/rotations/${direction}.png`;
        };
      }
      walkFrame = (walkFrame + 1) % 6;
    }, 100);
  }

  function stopWalking(direction) {
    if (walkInterval) {
      clearInterval(walkInterval);
      walkInterval = null;
    }
    playerImg.src = `${hoosier.sprite}/rotations/${direction}.png`;
  }

  // Keyboard controls
  const keys = { left: false, right: false };

  function handleKeyDown(e) {
    if (!tunnelGameActive) return;
    if (e.key === 'ArrowLeft' || e.key === 'a') {
      keys.left = true;
      startWalking('west');
    }
    if (e.key === 'ArrowRight' || e.key === 'd') {
      keys.right = true;
      startWalking('east');
    }
    if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') {
      e.preventDefault();  // Prevent page scroll
      if (!isJumping) {
        isJumping = true;
        jumpVelocity = jumpStrength;
        AudioSystem.playSound('click');
      }
    }
  }

  function handleKeyUp(e) {
    if (e.key === 'ArrowLeft' || e.key === 'a') {
      keys.left = false;
      if (!keys.right) stopWalking('west');
    }
    if (e.key === 'ArrowRight' || e.key === 'd') {
      keys.right = false;
      if (!keys.left) stopWalking('east');
    }
  }

  document.addEventListener('keydown', handleKeyDown);
  document.addEventListener('keyup', handleKeyUp);

  // Touch controls for mobile
  let touchStartX = 0;
  let touchStartY = 0;
  gameEl.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  });
  gameEl.addEventListener('touchmove', (e) => {
    if (!tunnelGameActive) return;
    const touchX = e.touches[0].clientX;
    const touchY = e.touches[0].clientY;
    const diffX = touchX - touchStartX;
    const diffY = touchStartY - touchY;  // Inverted for natural swipe up

    // Horizontal movement (using percentages)
    if (Math.abs(diffX) > 10) {
      if (diffX > 0) {
        playerXPercent = Math.min(npcXPercent - 10, playerXPercent + 1.5);
        playerImg.src = `${hoosier.sprite}/rotations/east.png`;
      } else {
        playerXPercent = Math.max(2, playerXPercent - 1.5);
        playerImg.src = `${hoosier.sprite}/rotations/west.png`;
      }
      playerEl.style.left = `${playerXPercent}%`;
      touchStartX = touchX;
    }

    // Swipe up to jump
    if (diffY > 30 && !isJumping) {
      isJumping = true;
      jumpVelocity = jumpStrength;
      AudioSystem.playSound('click');
      touchStartY = touchY;
    }
  });

  // Game loop
  function gameLoop() {
    if (!tunnelGameActive) return;

    // Move player horizontally (using percentages)
    const speed = 0.8;  // Percentage-based speed
    if (keys.left) {
      playerXPercent = Math.max(2, playerXPercent - speed);
    }
    if (keys.right) {
      playerXPercent = Math.min(npcXPercent - 10, playerXPercent + speed);
    }
    playerEl.style.left = `${playerXPercent}%`;

    // Handle jumping physics
    if (isJumping) {
      playerY += jumpVelocity;
      jumpVelocity -= gravity;

      // Land on ground
      if (playerY <= 0) {
        playerY = 0;
        isJumping = false;
        jumpVelocity = 0;
      }
    }
    playerEl.style.transform = `translateY(-${playerY}px)`;

    // Check coin collisions (using percentages for X, pixels for Y)
    const playerBottomPx = 70 + playerY;  // Base floor height + jump height
    coins.forEach(coin => {
      if (!coin.collected) {
        // X collision: within 8% of each other
        const dxPercent = Math.abs(playerXPercent - coin.xPercent);
        // Y collision: within 50px of each other
        const dyPx = Math.abs(playerBottomPx - coin.yPx);
        if (dxPercent < 8 && dyPx < 50) {
          coin.collected = true;
          coin.el.classList.add('collected');
          coinsCollected++;
          coinsDisplay.textContent = coinsCollected;
          AudioSystem.playSound('click');
        }
      }
    });

    // Check if reached NPC (percentage-based)
    if (playerXPercent >= npcXPercent - 12) {
      tunnelGameActive = false;
      speechEl.classList.add('visible');
      speechEl.textContent = "I have a question for you!";
      stopWalking('east');

      // Add coins to state and track for potential skip
      state.coins = (state.coins || 0) + coinsCollected;
      state.lastTunnelCoins = coinsCollected;  // Track for skip functionality
      saveState();
      setTopUI();

      messageEl.innerHTML = `<b>You collected ${coinsCollected} coins!</b> ${npc.name} wants to talk...`;

      // Clean up
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('keyup', handleKeyUp);

      // Proceed after delay
      setTimeout(() => {
        const town = state.towns[state.idx];
        if (town.type === "end") {
          state.stage = "end";
        } else if (town.type === "question") {
          state.stage = "question";
        } else if (town.type === "fact") {
          state.stage = "fact";
        } else {
          state.stage = "map";
        }
        saveState();
        render();
      }, 1500);
    }

    tunnelAnimationFrame = requestAnimationFrame(gameLoop);
  }

  gameLoop();

  // Show speech bubble after delay
  setTimeout(() => {
    if (tunnelGameActive) {
      speechEl.classList.add('visible');
    }
  }, 1000);
}

function getSceneClass(townName) {
  const urban = ["Indianapolis", "Fort Wayne", "Gary", "Hammond", "South Bend", "Evansville"];
  const lake = ["Michigan City", "La Porte", "Angola", "Elkhart"];
  const historic = ["Vincennes", "New Albany", "Richmond", "Terre Haute"];

  if (urban.includes(townName)) return "scene-urban";
  if (lake.includes(townName)) return "scene-lake";
  if (historic.includes(townName)) return "scene-historic";
  return "scene-rural";
}

function renderQuestion() {
  const town = state.towns[state.idx];
  const sceneClass = getSceneClass(town.name);
  const hoosier = getCurrentHoosier();
  const landmark = townLandmarks[town.name];

  // Play adventure music for questions
  AudioSystem.playMusic('adventure');

  appEl.innerHTML = `
    <div class="${sceneClass}" style="border-radius: 12px; padding: 20px; margin-bottom: 16px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
        ${getSpriteImg(hoosier, 56, "south")}
        <div>
          <h2 style="margin: 0;">üìç ${town.name}</h2>
          ${landmark ? `<small style="opacity: 0.7;">${landmark.name}</small>` : ''}
        </div>
      </div>
      ${landmark ? `
        <div class="landmark-container">
          <img src="${landmark.image}" alt="${landmark.name}" class="landmark-img" onerror="this.style.display='none'">
          <div class="landmark-label"><span class="icon">üì∏</span>${landmark.name}</div>
        </div>
      ` : ''}
    </div>
    <p><b>Question:</b> ${town.question}</p>
    <div class="choices" id="choices"></div>
    <div style="margin-top: 16px; text-align: center;">
      <button class="btn secondary" id="skipQuestionBtn" style="font-size: 13px; opacity: 0.8;">
        Skip Question (lose ${state.lastTunnelCoins || 0} coins)
      </button>
    </div>
    <div id="afterBox"></div>
  `;

  // Narrate the question
  setTimeout(() => {
    AudioSystem.speak(`Question: ${town.question}`, { rate: 0.9 });
  }, 500);

  const choicesEl = document.getElementById("choices");
  town.choices.forEach((c, i) => {
    const div = document.createElement("div");
    div.className = "choice";
    div.textContent = `${i + 1}. ${c}`;  // Add number prefix
    div.onclick = () => answer(i);
    choicesEl.appendChild(div);
  });

  // Skip button handler
  const skipBtn = document.getElementById('skipQuestionBtn');
  skipBtn.onclick = () => {
    if (answered) return;
    answered = true;
    document.removeEventListener('keydown', numberKeyHandler);

    // Subtract the coins from the tunnel that led to this question
    const coinsLost = state.lastTunnelCoins || 0;
    state.coins = Math.max(0, (state.coins || 0) - coinsLost);
    state.lastTunnelCoins = 0;
    saveState();
    setTopUI();

    AudioSystem.playSound('wrong');

    const after = document.getElementById("afterBox");
    after.innerHTML = `
      <div style="margin-top: 16px; padding: 16px; background: rgba(255,91,107,.1); border-radius: 12px; border: 1px solid #ff5b6b;">
        <p>‚è≠Ô∏è <b>Question Skipped!</b></p>
        <p style="opacity: 0.9; font-size: 14px;">You lost ${coinsLost} coins from the tunnel.</p>
        <p style="opacity: 0.8; font-size: 13px;">The correct answer was: <b>${town.choices[town.answerIndex]}</b></p>
        <div class="row" style="margin-top: 12px;">
          <button class="btn" id="continueBtn">Continue Journey</button>
        </div>
      </div>
    `;

    // Hide skip button
    skipBtn.style.display = 'none';

    document.getElementById("continueBtn").onclick = () => {
      AudioSystem.playSound('click');
      advanceToNext();
    };
    addEnterKeySupport("continueBtn");
  };

  // Number key support (1-4) for selecting answers
  let answered = false;
  const numberKeyHandler = (e) => {
    if (answered) return;
    const num = parseInt(e.key);
    if (num >= 1 && num <= town.choices.length) {
      e.preventDefault();
      answer(num - 1);
    }
  };
  document.addEventListener('keydown', numberKeyHandler);

  function answer(i) {
    answered = true;
    document.removeEventListener('keydown', numberKeyHandler);
    skipBtn.style.display = 'none';  // Hide skip button when answering
    const all = [...document.querySelectorAll(".choice")];
    all.forEach(x => x.onclick = null);

    // Clear lastTunnelCoins since they answered (didn't skip)
    state.lastTunnelCoins = 0;

    const correct = (i === town.answerIndex);
    if (correct) {
      state.score += 1;
      AudioSystem.playSound('correct');
    } else {
      AudioSystem.playSound('wrong');
    }

    all.forEach((el, idx) => {
      if (idx === town.answerIndex) el.classList.add("correct");
      else if (idx === i && !correct) el.classList.add("wrong");
    });

    const after = document.getElementById("afterBox");
    after.innerHTML = `
      <div style="margin-top: 16px; padding: 16px; background: ${correct ? 'rgba(31,209,139,.1)' : 'rgba(255,91,107,.1)'}; border-radius: 12px; border: 1px solid ${correct ? '#1fd18b' : '#ff5b6b'};">
        <p>${correct ? "‚úÖ Correct!" : "‚ùå Not quite."}</p>
        <p style="opacity: 0.9; font-size: 14px;">${town.fact}</p>
        <div class="row" style="margin-top: 12px;">
          <button class="btn" id="continueBtn">Continue Journey</button>
        </div>
      </div>
    `;

    // Narrate the result and fact
    setTimeout(() => {
      const resultText = correct ? "Correct!" : "Not quite.";
      AudioSystem.speak(`${resultText} ${town.fact}`, { rate: 0.9 });
    }, 500);

    document.getElementById("continueBtn").onclick = () => {
      AudioSystem.playSound('click');
      AudioSystem.stopSpeaking();
      advanceToNext();
    };

    // Enter key support for continue button
    addEnterKeySupport("continueBtn");
    saveState();
  }
}

function renderFact() {
  const town = state.towns[state.idx];
  const sceneClass = getSceneClass(town.name);
  const hoosier = getCurrentHoosier();
  const landmark = townLandmarks[town.name];

  // Award a free point for visiting a fact city (if not already awarded)
  if (!town.factPointAwarded) {
    state.score += 1;
    town.factPointAwarded = true;
    saveState();
    // Play a positive sound for earning the point
    setTimeout(() => AudioSystem.playSound('correct'), 300);
  }

  // Play adventure music for facts
  AudioSystem.playMusic('adventure');

  appEl.innerHTML = `
    <div class="${sceneClass}" style="border-radius: 12px; padding: 20px; margin-bottom: 16px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
        ${getSpriteImg(hoosier, 56, "south")}
        <div>
          <h2 style="margin: 0;">üìç ${town.name}</h2>
          ${landmark ? `<small style="opacity: 0.7;">${landmark.name}</small>` : ''}
        </div>
      </div>
      ${landmark ? `
        <div class="landmark-container">
          <img src="${landmark.image}" alt="${landmark.name}" class="landmark-img" onerror="this.style.display='none'">
          <div class="landmark-label"><span class="icon">üì∏</span>${landmark.name}</div>
        </div>
      ` : ''}
    </div>
    <div style="padding: 16px; background: rgba(43,99,255,.1); border-radius: 12px; border: 1px solid #2b63ff;">
      <p><b>üìö Did you know?</b></p>
      <p style="font-size: 15px;">${town.fact}</p>
      <div class="fact-timer"></div>
    </div>
    <p style="text-align: center; margin-top: 12px; color: #1fd18b; font-weight: bold;">‚ú® +1 point for visiting!</p>
    <p style="text-align: center; opacity: 0.6; font-size: 13px;">Auto-continuing in 4 seconds...</p>
  `;

  // Narrate the fact
  setTimeout(() => {
    AudioSystem.speak(`Did you know? ${town.fact}`, { rate: 0.9 });
  }, 300);

  setTimeout(() => {
    if (state.stage === "fact" && state.towns[state.idx] === town) {
      AudioSystem.stopSpeaking();
      advanceToNext();
    }
  }, 4000);
}

function advanceToNext() {
  const currentTown = state.towns[state.idx];

  if (currentTown.isArtifact && !state.hasArtifact) {
    state.hasArtifact = true;
    state.stage = "artifact";
    saveState();
    render();
    return;
  }

  state.idx += 1;

  if (state.idx >= state.towns.length - 1) {
    state.stage = "end";
  } else {
    state.stage = "map";  // Go back to map to show travel to next city
  }

  saveState();
  render();
}

function renderArtifact() {
  const hoosier = getCurrentHoosier();

  // Play artifact discovery sound and victory music
  AudioSystem.playSound('artifact');
  setTimeout(() => {
    AudioSystem.playMusic('victory');
  }, 1000);

  appEl.innerHTML = `
    <div class="artifact-found" style="border-radius: 12px; padding: 30px; text-align: center;">
      <h2>‚≠ê You Found the Astrolabe!</h2>
      <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0;">
        <img id="artifactSprite" src="${hoosier.sprite}/rotations/south.png" class="sprite-img" style="width:72px;height:72px;" alt="${hoosier.name}">
        <img src="images/astrolobe.png" style="width: 120px; height: 120px; border-radius: 50%; box-shadow: 0 4px 25px rgba(255,215,0,0.5);" alt="Astrolabe">
      </div>
      <p>Hidden in an old cellar in <b>Angola</b>, you discover the lost astrolabe!</p>
      <p>This precious instrument was carried during the "Trail of Death" march of 1838.</p>
    </div>
    <div style="height: 16px;"></div>
    <p style="text-align: center;">
      Your mission isn't over yet! You must return the artifact to Indianapolis,
      continuing to learn about Indiana along the way.
    </p>
    <div class="row" style="justify-content: center;">
      <button class="btn" id="continueBtn">üìú Continue with Artifact</button>
    </div>
  `;

  // Narrate the discovery
  setTimeout(() => {
    AudioSystem.speak(
      "You found the astrolabe! Hidden in an old cellar in Angola, you discover the lost navigation instrument. " +
      "This precious artifact was carried during the Trail of Death march of 1838. " +
      "Your mission isn't over yet! You must return it to Indianapolis.",
      { rate: 0.9 }
    );
  }, 800);

  // Play picking-up animation
  startSpriteAnimation("artifactSprite", hoosier, "picking-up", "south", 5, 6);

  document.getElementById("continueBtn").onclick = () => {
    AudioSystem.playSound('click');
    AudioSystem.stopSpeaking();
    stopSpriteAnimation();
    state.idx += 1;
    state.stage = "map";  // Show map travel to next city
    saveState();
    render();
  };

  // Enter key support
  addEnterKeySupport("continueBtn");
}

function renderEnd() {
  const maxScore = 26; // 19 questions + 7 facts
  const percentage = Math.round((state.score / maxScore) * 100);
  const hoosier = getCurrentHoosier();
  const totalPoints = state.score * 10 + state.coins;
  let rating = "üåü";
  let ratingText = "Keep learning!";
  if (percentage >= 90) { rating = "üåüüåüüåüüåüüåü LEGENDARY!"; ratingText = "Legendary!"; }
  else if (percentage >= 75) { rating = "üåüüåüüåüüåü Excellent!"; ratingText = "Excellent!"; }
  else if (percentage >= 60) { rating = "üåüüåüüåü Great job!"; ratingText = "Great job!"; }
  else if (percentage >= 40) { rating = "üåüüåü Good effort!"; ratingText = "Good effort!"; }
  else { rating = "üåü Keep learning!"; ratingText = "Keep learning!"; }

  // Play victory music
  AudioSystem.playMusic('victory');

  // Load existing leaderboard
  const leaderboard = loadLeaderboard();

  appEl.innerHTML = `
    <div style="text-align: center;">
      <h2>üèõÔ∏è Mission Complete!</h2>

      <!-- Ceremony Scene -->
      <div style="background: linear-gradient(180deg, #1a3a5c 0%, #0d1f33 100%); border-radius: 12px; padding: 20px; margin: 16px 0;">
        <p style="color: #ffd700; font-style: italic; margin-bottom: 16px;">At the Indiana State Capitol...</p>

        <div style="display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 20px 0;">
          ${getSpriteImg(hoosier, 72, "south")}
          <img src="images/astrolobe.png" style="width: 64px; height: 64px; border-radius: 50%; transform: translateY(-5px);" alt="Astrolabe">
          <div style="font-size: 36px;">‚û°Ô∏è</div>
          <div style="font-size: 64px;">üë®‚Äçüíº</div>
        </div>

        <p style="color: #e0e0e0;">You present the precious astrolabe to <b style="color: #ffd700;">Mayor Joe Hogsett</b>!</p>

        <div style="margin: 20px 0; padding: 16px; background: rgba(255,215,0,0.1); border: 2px solid #ffd700; border-radius: 8px;">
          <p style="color: #ffd700; font-size: 18px; margin: 0 0 12px;"><b>"On behalf of all Hoosiers..."</b></p>
          <div style="display: flex; justify-content: center; align-items: center; gap: 15px;">
            <span style="font-size: 48px;">üóùÔ∏è</span>
            <div style="text-align: left;">
              <p style="margin: 0; color: #ffd700; font-weight: bold;">The Key to the City!</p>
              <p style="margin: 4px 0 0; font-size: 14px; color: #aaa;">Awarded to ${hoosier.name}</p>
            </div>
          </div>
          <p style="color: #e0e0e0; margin: 12px 0 0; font-style: italic;">"For bravery, dedication, and preserving Indiana's heritage!"</p>
        </div>
      </div>
    </div>

    <div style="background: rgba(31,209,139,.1); border: 1px solid #1fd18b; border-radius: 12px; padding: 16px; text-align: center; margin: 16px 0;">
      <p style="margin: 0;"><b>Final Score:</b> ${state.score} / ${maxScore} (${percentage}%) | ü™ô ${state.coins} coins</p>
      <p style="margin: 4px 0 0; font-size: 14px; color: #aaa;"><b>Total Points:</b> ${totalPoints} (${state.score}√ó10 + ${state.coins} coins)</p>
      <p style="margin: 8px 0 0; font-size: 18px;">${rating}</p>
    </div>

    <div class="leaderboard">
      <h3 style="margin: 0 0 12px; text-align: center;">üèÜ Add to Leaderboard</h3>
      <div class="leaderboard-form" id="leaderboardForm">
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <input type="text" id="playerName" placeholder="Your Name" maxlength="20" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #3a4b7c; background: #1a2744; color: #fff;">
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <select id="playerTeacher" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #3a4b7c; background: #1a2744; color: #fff;">
            <option value="">Select Teacher</option>
            ${TEACHERS.map(t => `<option value="${t}">${t}</option>`).join('')}
            <option value="__other__">Other...</option>
          </select>
          <select id="playerSchool" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #3a4b7c; background: #1a2744; color: #fff;">
            <option value="">Select School</option>
            ${SCHOOLS.map(s => `<option value="${s}">${s}</option>`).join('')}
            <option value="__other__">Other...</option>
          </select>
        </div>
        <div id="customTeacherRow" style="display: none; margin-bottom: 8px;">
          <input type="text" id="customTeacher" placeholder="Enter Teacher Name" maxlength="30" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #3a4b7c; background: #1a2744; color: #fff; box-sizing: border-box;">
        </div>
        <div id="customSchoolRow" style="display: none; margin-bottom: 8px;">
          <input type="text" id="customSchool" placeholder="Enter School Name" maxlength="40" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #3a4b7c; background: #1a2744; color: #fff; box-sizing: border-box;">
        </div>
        <button class="btn" id="submitScoreBtn" style="width: 100%;">üìä Submit Score</button>
      </div>
      <div id="submitMsg" style="margin-top: 8px; text-align: center;"></div>

      <!-- Leaderboard Tabs -->
      <div style="display: flex; gap: 4px; margin: 16px 0 8px; justify-content: center;">
        <button class="btn small" id="tabIndividual" style="padding: 6px 12px; font-size: 12px;">ü•á Players</button>
        <button class="btn small secondary" id="tabClass" style="padding: 6px 12px; font-size: 12px;">üë©‚Äçüè´ Classes</button>
        <button class="btn small secondary" id="tabSchool" style="padding: 6px 12px; font-size: 12px;">üè´ Schools</button>
      </div>

      <div id="leaderboardList">
        ${renderIndividualLeaderboard(leaderboard)}
      </div>
    </div>

    <p style="margin-top: 16px;"><b>Write a one-sentence review of the game:</b></p>
    <textarea id="review" rows="3" placeholder="Example: I loved traveling through Indiana and learning cool facts about the Hoosier State!">${state.review || ""}</textarea>

    <div style="height: 12px;"></div>
    <div class="row">
      <button class="btn" id="saveReviewBtn">üíæ Save Review</button>
      <button class="btn secondary" id="playAgainBtn">üîÑ Play Again</button>
    </div>
    <div id="savedMsg" style="margin-top: 10px;"></div>
  `;

  // Narrate the ending
  setTimeout(() => {
    AudioSystem.speak(
      `Mission Complete! You present the astrolabe to Mayor Joe Hogsett at the Indianapolis Capitol! ` +
      `The Mayor is so grateful that he awards you the Key to the City! ` +
      `On behalf of all Hoosiers, for bravery, dedication, and preserving Indiana's heritage! ` +
      `Your final score is ${state.score} out of ${maxScore}, that's ${percentage} percent, plus ${state.coins} coins for a total of ${totalPoints} points. ${ratingText} ` +
      `Enter your name, teacher, and school to add your score to the leaderboard!`,
      { rate: 0.9 }
    );
  }, 500);

  // Tab switching for leaderboard
  let currentTab = 'individual';
  let currentLeaderboard = leaderboard;

  function updateTabStyles() {
    document.getElementById('tabIndividual').className = currentTab === 'individual' ? 'btn small' : 'btn small secondary';
    document.getElementById('tabClass').className = currentTab === 'class' ? 'btn small' : 'btn small secondary';
    document.getElementById('tabSchool').className = currentTab === 'school' ? 'btn small' : 'btn small secondary';
  }

  function refreshLeaderboardDisplay() {
    const listEl = document.getElementById("leaderboardList");
    if (currentTab === 'individual') {
      listEl.innerHTML = renderIndividualLeaderboard(currentLeaderboard);
    } else if (currentTab === 'class') {
      listEl.innerHTML = renderClassLeaderboard(currentLeaderboard);
    } else {
      listEl.innerHTML = renderSchoolLeaderboard(currentLeaderboard);
    }
  }

  document.getElementById('tabIndividual').onclick = () => {
    AudioSystem.playSound('click');
    currentTab = 'individual';
    updateTabStyles();
    refreshLeaderboardDisplay();
  };

  document.getElementById('tabClass').onclick = () => {
    AudioSystem.playSound('click');
    currentTab = 'class';
    updateTabStyles();
    refreshLeaderboardDisplay();
  };

  document.getElementById('tabSchool').onclick = () => {
    AudioSystem.playSound('click');
    currentTab = 'school';
    updateTabStyles();
    refreshLeaderboardDisplay();
  };

  // Show/hide custom input fields when "Other" is selected
  document.getElementById('playerTeacher').onchange = (e) => {
    const customRow = document.getElementById('customTeacherRow');
    customRow.style.display = e.target.value === '__other__' ? 'block' : 'none';
    if (e.target.value === '__other__') {
      document.getElementById('customTeacher').focus();
    }
  };

  document.getElementById('playerSchool').onchange = (e) => {
    const customRow = document.getElementById('customSchoolRow');
    customRow.style.display = e.target.value === '__other__' ? 'block' : 'none';
    if (e.target.value === '__other__') {
      document.getElementById('customSchool').focus();
    }
  };

  document.getElementById("submitScoreBtn").onclick = () => {
    AudioSystem.playSound('click');
    const name = document.getElementById("playerName").value.trim();
    const teacherSelect = document.getElementById("playerTeacher").value;
    const schoolSelect = document.getElementById("playerSchool").value;

    // Use custom values if "Other" was selected
    const teacher = teacherSelect === '__other__'
      ? document.getElementById("customTeacher").value.trim()
      : teacherSelect;
    const school = schoolSelect === '__other__'
      ? document.getElementById("customSchool").value.trim()
      : schoolSelect;

    if (!name) {
      document.getElementById("submitMsg").innerHTML = `<small style="color: #ff6b6b;">Please enter your name!</small>`;
      return;
    }
    if (!teacher) {
      document.getElementById("submitMsg").innerHTML = `<small style="color: #ff6b6b;">Please ${teacherSelect === '__other__' ? 'enter' : 'select'} your teacher!</small>`;
      return;
    }
    if (!school) {
      document.getElementById("submitMsg").innerHTML = `<small style="color: #ff6b6b;">Please ${schoolSelect === '__other__' ? 'enter' : 'select'} your school!</small>`;
      return;
    }

    currentLeaderboard = saveToLeaderboard(name, teacher, school, state.score, state.coins);

    // Refresh the current tab view
    refreshLeaderboardDisplay();

    // Hide the form and show success message
    document.getElementById("leaderboardForm").style.display = "none";
    document.getElementById("submitMsg").innerHTML = `<small style="color: #1fd18b;">‚úÖ Score submitted! You earned ${totalPoints} points!</small>`;
    AudioSystem.speak(`Score submitted! You earned ${totalPoints} points!`, { rate: 1.0 });
  };

  document.getElementById("saveReviewBtn").onclick = () => {
    AudioSystem.playSound('click');
    const txt = document.getElementById("review").value.trim();
    state.review = txt;
    saveState();
    document.getElementById("savedMsg").innerHTML = `<small style="color: #1fd18b;">‚úÖ Review saved! Thank you for playing!</small>`;
    AudioSystem.speak("Review saved! Thank you for playing Indiana Treasure Quest!", { rate: 1.0 });
  };

  document.getElementById("playAgainBtn").onclick = () => {
    AudioSystem.playSound('click');
    AudioSystem.stopSpeaking();
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  };
}

// Debug shortcut: Ctrl+Shift+D to open debug screen selector
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'D') {
    e.preventDefault();
    try {
      const choice = prompt(
        'DEBUG: Jump to screen\n\n' +
        '1 - Avatar Selection\n' +
        '2 - Backstory\n' +
        '3 - Sewer Scene\n' +
        '4 - Map View\n' +
        '5 - Question\n' +
        '6 - Fact\n' +
        '7 - Artifact (Angola)\n' +
        '8 - End Game\n\n' +
        'Enter number (1-8):'
      );
      if (!choice) return;

      const num = parseInt(choice);

      // Helper to ensure basic game state is set
      const ensureGameState = () => {
        if (!state.avatarId) {
          state.avatarId = famousHoosiers[0].id;
          state.avatar = famousHoosiers[0].emoji;
        }
        if (!state.towns || state.towns.length === 0) {
          state.towns = buildTownsArray();
        }
        if (state.score === undefined || state.score === null) state.score = 0;
        if (state.coins === undefined || state.coins === null) state.coins = 0;
        if (state.idx === undefined || state.idx === null) state.idx = 1;
      };

      // Find a town index with a question
      const findQuestionTown = () => {
        for (let i = 1; i < state.towns.length - 1; i++) {
          if (state.towns[i].type === 'question') return i;
        }
        return 1;
      };

      // Find a town index with a fact
      const findFactTown = () => {
        for (let i = 1; i < state.towns.length - 1; i++) {
          if (state.towns[i].type === 'fact') return i;
        }
        return 1;
      };

      switch(num) {
        case 1: // Avatar Selection
          state.stage = "avatar";
          state.avatar = null;
          state.avatarId = null;
          break;
        case 2: // Backstory
          ensureGameState();
          state.stage = "story";
          break;
        case 3: // Sewer
          ensureGameState();
          state.stage = "sewer";
          break;
        case 4: // Map
          ensureGameState();
          state.stage = "map";
          break;
        case 5: // Question
          ensureGameState();
          state.idx = findQuestionTown();
          state.stage = "question";
          break;
        case 6: // Fact
          ensureGameState();
          state.idx = findFactTown();
          state.stage = "fact";
          break;
        case 7: // Artifact (Angola)
          ensureGameState();
          state.idx = ARTIFACT_INDEX;
          state.stage = "artifact";
          break;
        case 8: // End Game
          ensureGameState();
          state.idx = routeOrder.length - 1;
          state.stage = "end";
          state.score = 15;
          state.coins = 25;
          break;
        default:
          alert('Invalid choice. Enter 1-8.');
          return;
      }
      saveState();
      render();
      console.log('DEBUG: Jumped to screen ' + num);
    } catch (err) {
      alert('DEBUG ERROR: ' + err.message);
      console.error('Debug shortcut error:', err);
    }
  }
});

// Start the game
render();
</script>
</body>
</html>
